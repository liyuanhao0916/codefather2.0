# 下单支付

## 业务分析

*   下单
    *   用户请求订单系统下单
    *   订单系统通过RPC调用订单服务下单
    *   订单服务调用优惠券服务，扣减优惠券
    *   订单服务调用库存服务，校验并扣减库存
    *   订单调用用户服务，扣减用户余额
    *   订单服务完成，确认订单
*   支付
    *   用户请求支付系统
    *   用户系统调用第三方平台API进行发起支付流程
    *   用户通过第三方平台支付成功后，第三方平台回调通知支付系统
    *   支付系统调用订单服务，修改订单状态
    *   支付系统调用积分服务，添加积分
    *   支付系统调用日志服务，记录日志

## 问题分析

*   用户通过第三方支付平台（支付宝、微信）支付成功后，第三方支付平台要通过回调API异步通知商家支付系统用户支付结果，支付系统根据支付结果修改订单状态、记录支付日志和给用户增加积分。商家支付系统如何保证在收到第三方支付平台的异步通知时，如何快速给第三方支付凭条做出回应？

    **通过MQ进行数据分发，提高系统处理性能**

*   用户提交订单后，扣减库存成功、扣减优惠券成功、使用余额成功，但是在确认订单操作失败，需要对库存、库存、余额进行回退。如何保证数据的完整性？

    **使用MQ保证在下单失败后系统数据的完整性**

## 技术分析

### 技术选型

*   SpringBoot
*   Dubbo
*   Zookeeper
*   RocketMQ
*   Mysql

## 环境搭建

### 数据库

#### 安装

```sh
docker pull mysql

docker run -p 3306:3306 --name mysql \
-e MYSQL_ROOT_PASSWORD=root \
-d mysql
```

#### 数据表

##### 优惠券表

| Field         | Type                | Comment        |
| ------------- | ------------------- | -------------- |
| coupon\_id    | bigint(50) NOT NULL | 优惠券ID          |
| coupon\_price | decimal(10,2) NULL  | 优惠券金额          |
| user\_id      | bigint(50) NULL     | 用户ID           |
| order\_id     | bigint(32) NULL     | 订单ID           |
| is\_used      | int(1) NULL         | 是否使用 0未使用 1已使用 |
| used\_time    | timestamp NULL      | 使用时间           |

##### 商品表

| Field         | Type                | Comment |
| ------------- | ------------------- | ------- |
| goods\_id     | bigint(50) NOT NULL | 主键      |
| goods\_name   | varchar(255) NULL   | 商品名称    |
| goods\_number | int(11) NULL        | 商品库存    |
| goods\_price  | decimal(10,2) NULL  | 商品价格    |
| goods\_desc   | varchar(255) NULL   | 商品描述    |
| add\_time     | timestamp NULL      | 添加时间    |

##### 订单表

| Field            | Type                | Comment                     |
| ---------------- | ------------------- | --------------------------- |
| order\_id        | bigint(50) NOT NULL | 订单ID                        |
| user\_id         | bigint(50) NULL     | 用户ID                        |
| order\_status    | int(1) NULL         | 订单状态 0未确认 1已确认 2已取消 3无效 4退款 |
| pay\_status      | int(1) NULL         | 支付状态 0未支付 1支付中 2已支付         |
| shipping\_status | int(1) NULL         | 发货状态 0未发货 1已发货 2已退货         |
| address          | varchar(255) NULL   | 收货地址                        |
| consignee        | varchar(255) NULL   | 收货人                         |
| goods\_id        | bigint(50) NULL     | 商品ID                        |
| goods\_number    | int(11) NULL        | 商品数量                        |
| goods\_price     | decimal(10,2) NULL  | 商品价格                        |
| goods\_amount    | decimal(10,0) NULL  | 商品总价                        |
| shipping\_fee    | decimal(10,2) NULL  | 运费                          |
| order\_amount    | decimal(10,2) NULL  | 订单价格                        |
| coupon\_id       | bigint(50) NULL     | 优惠券ID                       |
| coupon\_paid     | decimal(10,2) NULL  | 优惠券                         |
| money\_paid      | decimal(10,2) NULL  | 已付金额                        |
| pay\_amount      | decimal(10,2) NULL  | 支付金额                        |
| add\_time        | timestamp NULL      | 创建时间                        |
| confirm\_time    | timestamp NULL      | 订单确认时间                      |
| pay\_time        | timestamp NULL      | 支付时间                        |

##### 订单商品日志表

| Field         | Type                 | Comment |
| ------------- | -------------------- | ------- |
| goods\_id     | int(11) NOT NULL     | 商品ID    |
| order\_id     | varchar(32) NOT NULL | 订单ID    |
| goods\_number | int(11) NULL         | 库存数量    |
| log\_time     | datetime NULL        | 记录时间    |

##### 用户表

| Field           | Type                | Comment |
| --------------- | ------------------- | ------- |
| user\_id        | bigint(50) NOT NULL | 用户ID    |
| user\_name      | varchar(255) NULL   | 用户姓名    |
| user\_password  | varchar(255) NULL   | 用户密码    |
| user\_mobile    | varchar(255) NULL   | 手机号     |
| user\_score     | int(11) NULL        | 积分      |
| user\_reg\_time | timestamp NULL      | 注册时间    |
| user\_money     | decimal(10,0) NULL  | 用户余额    |

##### 用户余额日志表

| Field            | Type                | Comment           |
| ---------------- | ------------------- | ----------------- |
| user\_id         | bigint(50) NOT NULL | 用户ID              |
| order\_id        | bigint(50) NOT NULL | 订单ID              |
| money\_log\_type | int(1) NOT NULL     | 日志类型 1订单付款 2 订单退款 |
| use\_money       | decimal(10,2) NULL  | 操作金额              |
| create\_time     | timestamp NULL      | 日志时间              |

##### 订单支付表

| Field       | Type                | Comment     |
| ----------- | ------------------- | ----------- |
| pay\_id     | bigint(50) NOT NULL | 支付编号        |
| order\_id   | bigint(50) NULL     | 订单编号        |
| pay\_amount | decimal(10,2) NULL  | 支付金额        |
| is\_paid    | int(1) NULL         | 是否已支付 1否 2是 |

##### MQ消息生产表

| Field        | Type                  | Comment      |
| ------------ | --------------------- | ------------ |
| id           | varchar(100) NOT NULL | 主键           |
| group\_name  | varchar(100) NULL     | 生产者组名        |
| msg\_topic   | varchar(100) NULL     | 消息主题         |
| msg\_tag     | varchar(100) NULL     | Tag          |
| msg\_key     | varchar(100) NULL     | Key          |
| msg\_body    | varchar(500) NULL     | 消息内容         |
| msg\_status  | int(1) NULL           | 0:未处理;1:已经处理 |
| create\_time | timestamp NOT NULL    | 记录时间         |

##### MQ消息消费表

| Field               | Type                  | Comment              |
| ------------------- | --------------------- | -------------------- |
| msg\_id             | varchar(50) NULL      | 消息ID                 |
| group\_name         | varchar(100) NOT NULL | 消费者组名                |
| msg\_tag            | varchar(100) NOT NULL | Tag                  |
| msg\_key            | varchar(100) NOT NULL | Key                  |
| msg\_body           | varchar(500) NULL     | 消息体                  |
| consumer\_status    | int(1) NULL           | 0:正在处理;1:处理成功;2:处理失败 |
| consumer\_times     | int(1) NULL           | 消费次数                 |
| consumer\_timestamp | timestamp NULL        | 消费时间                 |
| remark              | varchar(500) NULL     | 备注                   |

### 项目初始化

#### 工程预览

*   父工程：shop-parent
*   订单系统：shop-order-web
*   支付系统：shop-pay-web
*   优惠券服务：shop-coupon-service
*   订单服务：shop-order-service
*   支付服务：shop-pay-service
*   商品服务：shop-goods-service
*   用户服务：shop-user-service
*   实体类：shop-pojo
*   持久层：shop-dao
*   接口层：shop-api
*   工具工程：shop-common

#### 工程关系

*   web层
    *   订单系统：shop-order-web
    *   支付系统：shop-pay-web
*   接口层
    *   shop-api
*   服务层（依赖RocketMQ、Dubbo、zookeeper、SpringBoot）
    *   优惠券服务：shop-coupon-service
    *   订单服务：shop-order-service
    *   支付服务：shop-pay-service
    *   商品服务：shop-goods-service
    *   用户服务：shop-user-service
*   持久层（mysql）
    *   shop-pojo
    *   shop-dao

#### 依赖关系

*   shop-parent

    ```xml
    <packaging>pom</packaging>
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.0.1.RELEASE</version>
    </parent>
    <properties>
        <maven.compiler.source>8</maven.compiler.source>
        <maven.compiler.target>8</maven.compiler.target>
        <rocketmq-spring-boot-starter-version>2.0.3</rocketmq-spring-boot-starter-version>
    </properties>
    <dependencies>
       <!--dubbo-->
       <dependency>
           <groupId>com.alibaba.spring.boot</groupId>
           <artifactId>dubbo-spring-boot-starter</artifactId>
           <version>2.0.0</version>
       </dependency>
       <!--spring-boot-stater-->
       <dependency>
           <groupId>org.springframework.boot</groupId>
           <artifactId>spring-boot-starter</artifactId>
           <exclusions>
               <exclusion>
                   <artifactId>log4j-to-slf4j</artifactId>
                   <groupId>org.apache.logging.log4j</groupId>
               </exclusion>
           </exclusions>
       </dependency>
       <!--zookeeper-->
        <dependency>
            <groupId>org.apache.zookeeper</groupId>
            <artifactId>zookeeper</artifactId>
            <version>3.4.10</version>
            <exclusions>
                <exclusion>
                    <groupId>org.slf4j</groupId>
                    <artifactId>slf4j-log4j12</artifactId>
                </exclusion>
                <exclusion>
                    <groupId>log4j</groupId>
                    <artifactId>log4j</artifactId>
                </exclusion>
            </exclusions>
        </dependency>
        <dependency>
            <groupId>com.101tec</groupId>
            <artifactId>zkclient</artifactId>
            <version>0.9</version>
            <exclusions>
                <exclusion>
                    <artifactId>slf4j-log4j12</artifactId>
                    <groupId>org.slf4j</groupId>
                </exclusion>
            </exclusions>
        </dependency>
        <!--Test-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
        </dependency>    
        <!--RocketMQ-->
        <dependency>
            <groupId>org.apache.rocketmq</groupId>
            <artifactId>rocketmq-spring-boot-starter</artifactId>
            <version>${rocketmq-spring-boot-starter-version}</version>
        </dependency>
        <!--lombok-->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <version>1.18.6</version>
        </dependency>
        <!--mybatis-plus-springboot-->
        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-boot-starter</artifactId>
            <version>3.4.2</version>
        </dependency>
    </dependencies>
    <modules>
        <module>../shop-order-web</module>
        <module>../shop-coupon-service</module>
        <module>../shop-user-service</module>
        <module>../shop-order-service</module>
        <module>../shop-pay-web</module>
        <module>../shop-pojo</module>
        <module>../shop-common</module>
        <module>../shop-api</module>
        <module>../shop-goods-service</module>
        <module>../shop-pay-service</module>
    </modules>
    <build>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.7.0</version>
                <configuration>
                    <target>1.8</target>
                    <source>1.8</source>
                </configuration>
            </plugin>
        </plugins>
    </build>
    ```

*   所有子工程继承父工程

*   shop-api（shop-pojo）

*   所有service（mysql-connector-java、shop-api、shop-common）

*   所有web（spring-boot-starter-web、shop-api、shop-common）

#### Mybatis-Plus逆向工程

```xml
<dependencies>
    <dependency>
        <groupId>com.baomidou</groupId>
        <artifactId>mybatis-plus-boot-starter</artifactId>
        <version>3.4.2</version>
    </dependency>
    <!--代码生成器-->
    <dependency>
        <groupId>com.baomidou</groupId>
        <artifactId>mybatis-plus-generator</artifactId>
        <version>3.4.1</version>
    </dependency>
    <!--velocity模板引擎-->
    <dependency>
        <groupId>org.apache.velocity</groupId>
        <artifactId>velocity-engine-core</artifactId>
        <version>2.3</version>
    </dependency>
    <dependency>
        <groupId>mysql</groupId>
        <artifactId>mysql-connector-java</artifactId>
        <version>8.0.28</version>
        <scope>runtime</scope>
    </dependency>
</dependencies>
```

```java
public class CodeGenerator {
	public static void main(String[] args) {
		//1.获取代码生成器的对象
		AutoGenerator autoGenerator = new AutoGenerator();

		//设置数据库相关配置
		DataSourceConfig dataSource = new DataSourceConfig();
		dataSource.setDriverName("com.mysql.cj.jdbc.Driver");
		dataSource.setUrl("jdbc:mysql://192.168.10.104:3306/trade?serverTimezone=UTC");
		dataSource.setUsername("root");
		dataSource.setPassword("root");
		autoGenerator.setDataSource(dataSource);

		//设置全局配置
		GlobalConfig globalConfig = new GlobalConfig();
		globalConfig.setOutputDir(System.getProperty("user.dir")+"/src/main/java");    //设置代码生成位置
		globalConfig.setOpen(true);    //设置生成完毕后是否打开生成代码所在的目录
		globalConfig.setAuthor("李某某");    //设置作者
		globalConfig.setFileOverride(true);     //设置是否覆盖原始生成的文件
		globalConfig.setMapperName("%sMapper");    //设置数据层接口名，%s为占位符，指代模块名称
		globalConfig.setServiceName("I%sService");    //设置业务层接口名
		//globalConfig.setIdType(IdType.ASSIGN_ID);   //设置Id生成策略
		autoGenerator.setGlobalConfig(globalConfig);

		//设置包名相关配置
		PackageConfig packageInfo = new PackageConfig();
		packageInfo.setParent("com.botuer.shop");   //设置生成的包名，与代码所在位置不冲突，二者叠加组成完整路径
		packageInfo.setEntity("pojo");    //设置实体类包名
		packageInfo.setMapper("mapper");   //设置数据层包名
		autoGenerator.setPackageInfo(packageInfo);

		//策略设置
		StrategyConfig strategyConfig = new StrategyConfig();
		strategyConfig.setInclude(
				"trade_coupon",
				"trade_goods",
				"trade_goods_number_log",
				"trade_order",
				"trade_pay",
				"trade_user",
				"trade_user_money_log",
				"trade_mq_consumer_log",
				"trade_mq_producer_temp");  //设置当前参与生成的表名，参数为可变参数
		strategyConfig.setNaming(NamingStrategy.underline_to_camel); //设置下划线转驼峰
		strategyConfig.setTablePrefix("trade_");  //设置数据库表的前缀名称，模块名 = 数据库表名 - 前缀名  例如： User = tbl_user - tbl_
		strategyConfig.setRestControllerStyle(true);    //设置是否启用Rest风格
		//strategyConfig.setVersionFieldName("version");  //设置乐观锁字段名
		//strategyConfig.setLogicDeleteFieldName("deleted");  //设置逻辑删除字段名
		strategyConfig.setEntityLombokModel(true);  //设置是否启用lombok
		autoGenerator.setStrategy(strategyConfig);
		//2.执行生成操作
		autoGenerator.execute();
	}

}
```

*   实体类导入到shop-pojo工程的com.botuer.shop.pojo包下

*   Service导入到shop-api工程com.botuer.shop.service包下

*   Mapper导入到对应服务层

*   Controller导入到对应Web层

#### 公共类shop-common

*   ID生成器

    IDWorker：Twitter雪花算法

*   异常处理

    CustomerException：自定义异常类，继承RuntimeException

    CastException：异常抛出类

    ShopCode：系统状态类

*   响应实体类（在shop-pojo工程中）

    Result：封装响应状态和响应信息

## 下单业务

![image-20220713111217590](https://gitee.com/liyuanhao0916/Typora_images/raw/master/img/image-20220713111217590.png)

### 确认订单

> 校验订单>>生成预订单>>扣减库存>>扣减优惠券>>扣减用户余额>>确认订单
>
> '{校验订单，生成预订单，扣减库存，扣减优惠券，扣减余额}'

*   IOrderService 定义确认订单方法

    ```java
    public interface IOrderService {
        /**
         * 确认订单
         * @param order
         * @return Result
         */
        Result confirmOrder(Order order);
    }
    ```

*   OrderService  业务类实现

    Bean对象注入：

    *   业务层 @Reference
    *   持久层 @Autowired

    ```java
    @Slf4j
    @Component
    @Service(interfaceClass = IOrderService.class)
    public class OrderServiceImpl implements IOrderService {

        @Override
        public Result confirmOrder(Order order) {
          //1.校验订单
          checkOrder(order);
          //2.生成预订单
          Long orderId = savePreOrder(order);
            try {
              //3.扣减库存
              reduceGoodsNumber(order);
              //4.扣减优惠券
              updateCouponStatus(order);
              //5.使用余额
              reduceMoneyPaid(order);
              
              //模拟抛异常
    					//CastException.cast(ShopCode.SHOP_FAIL);

              //6.确认订单
              updateOrderStatus(order);
              //7.返回成功状态
              return new Result(ShopCode.SHOP_SUCCESS.getSuccess(),ShopCode.SHOP_SUCCESS.getMessage());
            } catch (Exception e) {
              //1.确认订单失败,发送消息
              //2.返回失败状态
              return new Result(ShopCode.SHOP_FAIL.getSuccess(),ShopCode.SHOP_FAIL.getMessage());
            }
        }
    }
    ```

#### 校验订单

> 校验订单{订单是否为空，
>
> ​	商品是否存在，
>
> ​	用户是否存在，
>
> ​	商品单价是否合法，
>
> ​	购买数量是否合法}

> **存在校验：（查库）、空值**
>
> **合法校验：两对象属性值对比**（order的商品单价 != 查到的goods的商品单价）(order的购买数量 >= 查到的goods的库存)

**商品是否存在**

*   商品查询数据库本身属于goods业务层，故需要调用goodService

    ```java
    public interface IGoodsService{
      /**
      *根据ID查good对象
      */
      Goods findOne(Long orderId);
    }
    ```

    ```java
    public class GoodsServiceImpl implements IGoodsService{
      
      @Autowired
    	private GoodsMapper goodsMapper;
      
      @Override
    	public Goods findOne(Long goodsId) {
    		if (goodsId == null) {
    			CastException.cast(ShopCode.SHOP_REQUEST_PARAMETER_INVALID);
    		}
    		return goodsMapper.selectById(goodsId);
    }
    ```

**用户是否存在**：同上

```java
private void checkOrder(Order order){
	//校验订单是否存在
	if(order == null){
		CastException.cast(ShopCode.SHOP_ORDER_INVALID);
	}
	//校验订单是否有商品（调goodsService）
	Goods goods = goodsService.findOne(order.getGoodsId());
	if(goods == null){
		CastException.cast(ShopCode.SHOP_GOODS_NO_EXIST);
	}
	//校验下单用户是否存在
	User user = userService.findOne(order.getUserId());
	if(user == null){
		CastException.cast(ShopCode.SHOP_USER_NO_EXIST);
	}
	//校验商品单价是否合法
	if(order.getGoodsPrice() != goods.getGoodsPrice()) {
		CastException.cast(ShopCode.SHOP_GOODS_PRICE_INVALID);
	}
	//校验订单数量是否合法
	if(order.getGoodsNumber() >= goods.getGoodsNumber()) {
		CastException.cast(ShopCode.SHOP_GOODS_NUM_NOT_ENOUGH);
	}
	log.info("校验订单通过");
}
```

#### 生成预订单

> 生成预订单{
>
> ​	设置订单状态不可见，
>
> ​	设置订单Id（雪花算法），
>
> ​	核算运费是否正确，
>
> ​	核算订单总额是否正确，
>
> ​	是否使用优惠券{
>
> ​		判断优惠券是否合法{
>
> ​			优惠券不存在，
>
> ​			优惠券已使用}}，
>
> ​	是否使用余额{
>
> ​		判断余额是否合法{
>
> ​			无余额，
>
> ​			有余额校验用户}}，
>
> ​	核算订单总价，
>
> ​	设置订单时间，
>
> ​	保存订单到数据库}

```java
/**
	 * 核算运费：订单金额大于100免运费，否则运费10元
	 * @param orderAmount 订单金额
	 * @return BigDecimal 运费价格
	 */
	private BigDecimal calculateShippingFee(BigDecimal orderAmount){
		if(orderAmount.compareTo(new BigDecimal(100)) == 1){
			return BigDecimal.ZERO;
		}else {
		    return new BigDecimal(10);
		}
	}
```

```java
/**
	 * 生成预订单
	 * @param order 订单
	 * @return 订单ID,用于补偿机制
	 */
private Long savePreOrder(Order order){

		//设置订单状态为不可见
		order.setOrderStatus(ShopCode.SHOP_ORDER_NO_CONFIRM.getCode());
		//订单ID
		order.setOrderId(idWorker.nextId());
		//核算运费是否正确
		BigDecimal shippingFee = calculateShippingFee(order.getOrderAmount());
		if ( order.getShippingFee().compareTo(shippingFee) != 0){
			CastException.cast(ShopCode.SHOP_ORDER_SHIPPINGFEE_INVALID);
		}
		//计算订单总价格是否合法
		BigDecimal orderAmount = order.getGoodsPrice().multiply(new BigDecimal(order.getGoodsNumber()));
		orderAmount.add(shippingFee);
		if(order.getOrderAmount().compareTo(orderAmount) != 0){
			CastException.cast(ShopCode.SHOP_ORDERAMOUNT_INVALID);
		}
		//判断优惠券信息是否合法
		Long couponId = order.getCouponId();
		if (couponId != null){
			Coupon coupon = couponService.findOne(couponId);
			//优惠券不存在
			if(coupon == null){
				CastException.cast(ShopCode.SHOP_COUPON_NO_EXIST);
			}
			//优惠券已使用
			if(ShopCode.SHOP_COUPON_ISUSED.getCode() == coupon.getIsUsed()){
				CastException.cast(ShopCode.SHOP_COUPON_ISUSED);
			}
			//优惠券金额生效
			order.setCouponPaid(coupon.getCouponPrice());
		}else {
			//优惠券金额为0
		    order.setCouponPaid(BigDecimal.ZERO);
		}
		//检验余额
		BigDecimal moneyPaid = order.getMoneyPaid();
		//比较 优惠券+余额 与 订单金额 大小
		int m = order.getMoneyPaid().add(order.getCouponPaid()).compareTo(order.getOrderAmount());
		if (moneyPaid!= null){
			//有无余额
			int i = order.getMoneyPaid().compareTo(BigDecimal.ZERO);
			//无余额
			if (i == -1){
				CastException.cast(ShopCode.SHOP_MONEY_PAID_LESS_ZERO);
				//有余额，校验用户
			}else if(i == 1){
				User user = userService.findOne(order.getUserId());
				if(user==null){
					CastException.cast(ShopCode.SHOP_USER_NO_EXIST);
				}
			}else{
				if (m < 0){
					order.setMoneyPaid(BigDecimal.ZERO);
				}
			}
		}
		//核算订单金额	支付金额 = 订单总金额 - （ 余额 + 优惠券 ）
		if (m < 0) {
			BigDecimal payAmount = order.getOrderAmount()
					.subtract(order.getMoneyPaid()
							.add(order.getCouponPaid()));
			order.setPayAmount( payAmount );
		}
		//设置下单时间
		order.setAddTime(LocalDateTime.now());
		//保存订单到数据库
		orderMapper.insert(order);
		//返回订单ID
		return order.getOrderId();
	}
```

#### 扣减库存

> 需要 订单ID、商品id、库存数量，正好和GoodsNumberLog成员变量相匹配

```java
/**
	 * 扣减库存
	 * @param order 订单
	 */
	private void reduceGoodsNumber(Order order){
		GoodsNumberLog goodsNumberLog = new GoodsNumberLog();
		goodsNumberLog.setOrderId(order.getOrderId());
		goodsNumberLog.setGoodsId(order.getGoodsId());
		goodsNumberLog.setGoodsNumber(order.getGoodsNumber());
		Result result = goodsService.reduceGoodsNumber(goodsNumberLog);
		if (result.getSuccess() == ShopCode.SHOP_FAIL.getSuccess()) {
			CastException.cast(ShopCode.SHOP_REDUCE_GOODS_NUM_FAIL);
		}
		log.info("订单： " + order.getOrderId() + "，扣减库存成功");
	}
```

**编写IGoodsService**

```java
public interface IGoodsService extends IService<Goods> {
	/**
	 * 根据Id查商品对象
	 * @param goodsId
	 * @return
	 */
	Goods findOne(Long goodsId);
	/**
	 * 扣减库存
	 * @param goodsNumberLog
	 * @return
	 */
	Result reduceGoodsNumber(GoodsNumberLog goodsNumberLog);
}
```

> 扣减库存{
>
> ​	存在性检验{
>
> ​		库存日志对象非空,
>
> ​		商品ID非空，
>
> ​		库存数量非空，
>
> ​		库存数量<=0}，
>
> ​	库存不足，
>
> ​	减库存，
>
> ​	记录库存日志}

```java
@Override
	public Result reduceGoodsNumber(GoodsNumberLog goodsNumberLog) {
		if (goodsNumberLog == null ||
				goodsNumberLog.getGoodsNumber() == null ||
				goodsNumberLog.getOrderId() == null ||
				goodsNumberLog.getGoodsNumber().intValue() <= 0) {
		    CastException.cast(ShopCode.SHOP_REQUEST_PARAMETER_INVALID);
		}
		Goods goods = goodsMapper.selectById(goodsNumberLog.getGoodsId());
		//库存不足
		if (goods.getGoodsNumber() < goodsNumberLog.getGoodsNumber()){
			CastException.cast(ShopCode.SHOP_GOODS_NUM_NOT_ENOUGH);
		}
		//减库存
		goods.setGoodsNumber(goods.getGoodsNumber() - goodsNumberLog.getGoodsNumber());
		goodsMapper.updateById(goods);
		//记录库存操作日志
		goodsNumberLog.setGoodsNumber(-goodsNumberLog.getGoodsNumber());
		goodsNumberLog.setLogTime(LocalDateTime.now());
		goodsNumberLogMapper.insert(goodsNumberLog);
		return new Result(ShopCode.SHOP_SUCCESS.getSuccess(),ShopCode.SHOP_SUCCESS.getMessage());
	}
```

#### 扣减优惠券

> 使用优惠券{
>
> ​	是否使用，
>
> ​	优惠券存在性经验，
>
> ​	扣减优惠券}

```java
/**
	 * 使用优惠券
	 * @param order
	 */
	private void updateCouponStatus(Order order){

		if (order.getCouponId() != null){
			Coupon coupon = couponService.findOne(order.getCouponId());
			coupon.setCouponId(order.getCouponId());
			coupon.setIsUsed(ShopCode.SHOP_COUPON_ISUSED.getCode());
			coupon.setUsedTime(LocalDateTime.now());

			//更新优惠券状态
			Result result = couponService.updateCouponStatus(coupon);
			if (result.getSuccess() == ShopCode.SHOP_FAIL.getSuccess()) {
				CastException.cast(ShopCode.SHOP_COUPON_USE_FAIL);
			}
			log.info("订单： " + order.getOrderId() + ",使用优惠券");
		}
	}
```

**编写ICouponService**

```java
public interface ICouponService extends IService<Coupon> {
	/**
	 * 根据ID查优惠券
	 * @param couponId
	 * @return
	 */
	Coupon findOne(Long couponId);

	/**
	 * 更新优惠券状态
	 * @param coupon
	 * @return
	 */
	Result updateCouponStatus(Coupon coupon);
}
```

```java
@Override
	public Result updateCouponStatus(Coupon coupon) {
		if (coupon == null || coupon.getCouponId() == null){
			CastException.cast(ShopCode.SHOP_REQUEST_PARAMETER_INVALID);
		}
		//更新订单状态
		couponMapper.updateById(coupon);
		return new Result(ShopCode.SHOP_SUCCESS.getSuccess(), ShopCode.SHOP_SUCCESS.getMessage());
	}
```

#### 扣减余额

> 需要 订单ID、用户ID、用户余额 正好符合UserMoneyLog

```java
private void reduceMoneyPaid(Order order) {
		if (order.getMoneyPaid() != null && order.getMoneyPaid().compareTo(BigDecimal.ZERO)==1){
			UserMoneyLog userMoneyLog = new UserMoneyLog();
			userMoneyLog.setOrderId(order.getOrderId());
			userMoneyLog.setUserId(order.getUserId());
			userMoneyLog.setUseMoney(order.getMoneyPaid());
			userMoneyLog.setMoneyLogType(ShopCode.SHOP_USER_MONEY_PAID.getCode());
			userService.updateMoneyPaid(userMoneyLog);
		}
	}
```

**编写IUserservice**

```java
public interface IUserService extends IService<User> {
	/**
	 * 根据ID查用户
	 * @param userId
	 * @return
	 */
	User findOne(Long userId);

	/**
	 * 使用余额
	 * @param userMoneyLog
	 * @return
	 */
	Result updateMoneyPaid(UserMoneyLog userMoneyLog);
}
```

```java
@Override
	public Result updateMoneyPaid(UserMoneyLog userMoneyLog) {
		//校验参数
		if (userMoneyLog == null ||
				userMoneyLog.getUserId() == null ||
				userMoneyLog.getOrderId() ==null ||
				userMoneyLog.getUseMoney() == null ||
				userMoneyLog.getUseMoney().compareTo(BigDecimal.ZERO) <= 0) {
			CastException.cast(ShopCode.SHOP_REQUEST_PARAMETER_INVALID);
		}
		//查询订单余额使用日志
		LambdaQueryWrapper<UserMoneyLog> lqw = new LambdaQueryWrapper<>();
		lqw.eq(userMoneyLog.getUserId()!= null,
						UserMoneyLog::getUserId,
						userMoneyLog.getUserId())
				.eq(userMoneyLog.getOrderId()!= null,
						UserMoneyLog ::getOrderId,
						userMoneyLog.getOrderId());
		int size = userMoneyLogMapper.selectList(lqw).size();
		User user = userMapper.selectById(userMoneyLog.getUserId());
		//扣减余额
		if (userMoneyLog.getMoneyLogType().intValue() == ShopCode.SHOP_USER_MONEY_PAID.getCode().intValue()){
			if (size > 0){
				//已经付款
				CastException.cast(ShopCode.SHOP_ORDER_PAY_STATUS_IS_PAY);
			}
			//扣减余额
			user.setUserMoney(user.getUserMoney().subtract(userMoneyLog.getUseMoney()));
			userMapper.updateById(user);
		}
		//回退余额
		if (userMoneyLog.getMoneyLogType().intValue()==ShopCode.SHOP_USER_MONEY_REFUND.getCode().intValue()){
			//订单未付款，不能退款
			if (size < 0) {
				CastException.cast(ShopCode.SHOP_ORDER_PAY_STATUS_NO_PAY);
			}
			//防止多次退款
			LambdaQueryWrapper<UserMoneyLog> lqw2 = new LambdaQueryWrapper<>();
			lqw2.eq(userMoneyLog.getUserId()!= null,
							UserMoneyLog::getUserId,
							userMoneyLog.getUserId())
					.eq(userMoneyLog.getOrderId()!= null,
							UserMoneyLog::getOrderId,
							userMoneyLog.getOrderId())
					.eq(userMoneyLog.getMoneyLogType()!= null,
							UserMoneyLog::getMoneyLogType,
							ShopCode.SHOP_USER_MONEY_REFUND.getCode());
			int size1 = userMoneyLogMapper.selectList(lqw2).size();
			if (size1 > 0) {
				CastException.cast(ShopCode.SHOP_USER_MONEY_REFUND_ALREADY);
			}
			//退款
			user.setUserMoney(user.getUserMoney().add(userMoneyLog.getUseMoney()));
			userMapper.updateById(user);
		}
		//记录日志
		userMoneyLog.setCreateTime(LocalDateTime.now());
		userMoneyLogMapper.updateById(userMoneyLog);
		return new Result(ShopCode.SHOP_SUCCESS.getSuccess(),ShopCode.SHOP_SUCCESS.getMessage());
	}
```

#### 确认订单

```java
private void updateOrderStatus(Order order) {
		order.setOrderStatus(ShopCode.SHOP_ORDER_CONFIRM.getCode());
		order.setPayStatus(ShopCode.SHOP_ORDER_PAY_STATUS_NO_PAY.getCode());
		order.setConfirmTime(LocalDateTime.now());
		int i = orderMapper.updateById(order);
		if (i <= 0) {
			CastException.cast(ShopCode.SHOP_ORDER_CONFIRM_FAIL);
		}
		log.info("订单： " + order.getOrderId() + "确认订单成功");
	}
```

#### 测试

*   启动类

    注解@SpringBootApplication、@EnableDubboConfiguration、MapperScan（“\*\*\*.mappper”）

    **注意：shop-order-service工程启动类需要注入用到的Bean（雪花算法）**

*   配置文件application.yml

    **注意：不同服务内部调用端口号不同**

    ```yaml
    spring:
      application:
        name: dubbo-coupon-provider
      dubbo:
        application:
          id: dubbo-coupon-provider
          name: dubbo-coupon-provider
        registry:
          address: zookeeper://192.168.10.103:2181;zookeeper://192.168.10.103:2182;zookeeper://192.168.10.103:2183
        server: true
        protocol:
          name: dubbo
          port: 20884 #不同服务内部调用端口号不同

      datasource:
        driver-class-name: com.mysql.cj.jdbc.Driver
        url: jdbc:mysql://192.168.10.104:3306/trade?serverTimezone=UTC
        username: root
        password: root

    logging:
      level:
        com:
          lawt:
            repository:
              mapper: debug
    mybatis-plus:
      configuration:
        log-impl: org.apache.ibatis.logging.stdout.StdOutImpl

    ```

*   测试类

    **注意：只需启动依赖的服务，测试的服务在启动测试方法时自动启动测试服务**

    ```java
    @RunWith(SpringRunner.class)
    @SpringBootTest(classes = OrderServiceApplication.class)
    public class OrderServiceTest {
    	@Autowired
    	private IOrderService orderService;
    	@Test
    	public void testConfirmOrder() throws IOException {
    		Long couponId = 345988230098857984L;
    		Long goodsId = 345959443973935104L;
    		Long userId = 345963634385633280L;

    		Order order = new Order();
    		order.setGoodsId(goodsId);
    		order.setUserId(userId);
    		order.setCouponId(couponId);
    		order.setAddress("北京");
    		order.setGoodsNumber(1);
    		order.setGoodsPrice(new BigDecimal(5000));
    		order.setShippingFee(BigDecimal.ZERO);
    		order.setOrderAmount(new BigDecimal(5000));
    		order.setMoneyPaid(new BigDecimal(100));
    		orderService.confirmOrder(order);

    		//System.in.read();
    	}
    ```

*   报错

    *   端口号占用：不要启动被测服务
    *   sql出现“where null = ？”：代码生成器生成的pojo未给主键加注解@TableId(value = "coupon\_id")

### 失败补偿机制

#### **发送消息**

*   **配置RocketMQ**

    ```yaml
    rocketmq:
      name-server: 192.168.10.101:9876;192.168.10.102:9876
      producer:
        group: orderProducerGroup

    mq:
      order:
        consumer:
          group:
            name: order_orderTopic_cancel_group
        topic: orderTopic
        #接收方不需要配置tag
        tag:
          cancel: order_cancel
          confirm: order_confirm
    ```

*   OderServiceImpl注入模版类、属性值

    ```java
     @Autowired
     private RocketMQTemplate rocketMQTemplate;

     @Value("${mq.order.topic}")
     private String topic;

     @Value("${mq.order.tag.cancel}")
     private String cancelTag;
    ```

*   发送下单失败消息

    消息应包含回退所必须的内容，封装到实体类MQEntity

    *   回退商品库存，需要  **商品id、订单id、商品数量**
    *   回退余额，需要  **用户id、使用余额**
    *   回退优惠券，需要 **优惠券id**

    ```java
    @Slf4j
    @Service
    @com.alibaba.dubbo.config.annotation.Service(interfaceClass = IOrderService.class)
    public class OrderServiceImpl extends ServiceImpl<OrderMapper, Order> implements IOrderService {

    	@Reference
    	private IGoodsService goodsService;
    	@Reference
    	private IUserService userService;
    	@Reference
    	private ICouponService couponService;
    	@Autowired
    	private OrderMapper orderMapper;
    	@Autowired
    	private IDWorker idWorker;
    	
      @Autowired
    	private RocketMQTemplate rocketMQTemplate;
    	@Value("${mq.order.topic}")
    	private String topic;
    	@Value("${mq.order.tag.cancel}")
    	private String cancelTag;

    	@Override
    	public Result confirmOrder(Order order) {
    		//校验订单
    		checkOrder(order);
    		//生成预订单
    		Long orderId = savePreOrder(order);
    		try {
    			//扣减库存
    			reduceGoodsNumber(order);
    			//扣减优惠券
    			updateCouponStatus(order);
    			//使用余额
    			reduceMoneyPaid(order);
    			//模拟抛异常
    			//CastException.cast(ShopCode.SHOP_FAIL);
    			//确认订单
    			updateOrderStatus(order);
    			//返回成功状态
    			return new Result(ShopCode.SHOP_SUCCESS.getSuccess(),ShopCode.SHOP_SUCCESS.getMessage());
    		} catch (Exception e) {
    			//确认订单失败，发送消息
    			MQEntity mqEntity = new MQEntity();
    			mqEntity.setOrderId(orderId);
    			mqEntity.setCouponId(order.getCouponId());
    			mqEntity.setGoodsId(order.getGoodsId());
    			mqEntity.setUserId(order.getUserId());
    			mqEntity.setUseMoney(order.getMoneyPaid());
    			mqEntity.setGoodsNum(order.getGoodsNumber());
    			//发送失败消息
    			try {
    				sendCancelOrder(topic,cancelTag,order.getOrderId().toString(), JSON.toJSONString(mqEntity));
    			} catch (Exception ex) {
    				ex.printStackTrace();
    				CastException.cast(ShopCode.SHOP_MQ_SEND_MESSAGE_FAIL);
    			}
    			return new Result(ShopCode.SHOP_FAIL.getSuccess(),ShopCode.SHOP_FAIL.getMessage());
    		}
    	}
    ```

    ```java
    /**
    	 * 发送订单失败消息
    	 * @param topic
    	 * @param cancelTag
    	 * @param keys 以订单ID为keys
    	 * @param body
    	 */
    	private void sendCancelOrder(String topic,  String cancelTag, String keys, String body)  {
    		if (StringUtils.isEmpty(topic)) {
    			CastException.cast(ShopCode.SHOP_MQ_TOPIC_IS_EMPTY);
    		}
    		if (StringUtils.isEmpty(body)) {
    			CastException.cast(ShopCode.SHOP_MQ_MESSAGE_BODY_IS_EMPTY);
    		}
    		Message message = new Message(topic,cancelTag,keys,body.getBytes());
    		rocketMQTemplate.convertAndSend(message);
    	}
    ```

#### 接收消息

> 创建监听类，消费消息

*   更改订单状态

    ```java
    @Slf4j
    @Component
    //设置监听到Topic、消费者组、消息模型设为广播
    @RocketMQMessageListener(topic = "${mq.order.topic}",consumerGroup = "${mq.order.consumer.group.name}",messageModel = MessageModel.BROADCASTING)
    public class CancelMQListener implements RocketMQListener<MessageExt> {
    	
    	@Autowired
    	private OrderMapper orderMapper;
    	@Override
    	public void onMessage(MessageExt messageExt) {
    		try {
    			//解析消息内容
    			String body = new String(messageExt.getBody());
    			MQEntity mqEntity = JSON.parseObject(body, MQEntity.class);
    			log.info("接收消息成功");
    			//查询订单
    			Long orderId = mqEntity.getOrderId();
    			Order order = orderMapper.selectById(orderId);
    			//更改订单状态
    			order.setOrderStatus(ShopCode.SHOP_ORDER_CANCEL.getCode());
    			orderMapper.updateById(order);
    			log.info("订单状态已设置为取消");
    		} catch (Exception e) {
    			e.printStackTrace();
    			log.info("订单取消失败");
    		}
    	}
    }
    ```

*   回退库存

    > 回退库存{
    >
    > ​	解析消息、消费消息
    >
    > ​	有未处理{
    >
    > ​		处理过{
    >
    > ​			处理成功、正在处理 ---> 直接结束
    >
    > ​			处理失败--判断消费消息次数--超过5次直接退出
    >
    > ​						不超过5次-----数据库乐观锁方式更改消息，处理状态为正在处理
    >
    > ​						更改库存--处理状态为处理成功}
    >
    > ​		未处理{
    >
    > ​			更改消息状态为正在处理
    >
    > ​			更改库存 --- 处理状态为处理成功}}}

    ```java
    @Slf4j
    @RocketMQMessageListener(topic = "${mq.order.topic}",consumerGroup = "${mq.order.consumer.group.name}",messageModel = MessageModel.BROADCASTING)
    @Component
    public class CancelMQListener implements RocketMQListener<MessageExt> {
    	@Value("${mq.order.consumer.group.name}")
    	private String groupName;
    	@Autowired
    	private MqConsumerLogMapper mqConsumerLogMapper;
    	@Autowired
    	private GoodsMapper goodsMapper;

    	@Override
    	public void onMessage(MessageExt messageExt) {
    		String msgId = null;
    		String tags = null;
    		String keys = null;
    		String body = null;
    		try {
    			//解析消息
    			msgId = messageExt.getMsgId();
    			tags = messageExt.getTags();
    			keys = messageExt.getKeys();
    			body = new String(messageExt.getBody());
    			log.info("接收消息成功");
    			//查询消费消息记录
    			LambdaQueryWrapper<MqConsumerLog> lqm = new LambdaQueryWrapper<>();
    			lqm.eq(MqConsumerLog::getGroupName, groupName)
    					.eq(MqConsumerLog::getMsgTag, tags)
    					.eq(MqConsumerLog::getMsgKey, keys);
    			MqConsumerLog mqConsumerLog = mqConsumerLogMapper.selectOne(lqm);
    			if (mqConsumerLog != null) {
    				//获取处理状态
    				Integer status = mqConsumerLog.getConsumerStatus();
    				//已处理
    				if (status.intValue() == ShopCode.SHOP_MQ_MESSAGE_STATUS_SUCCESS.getCode().intValue()) {
    					log.info("消息：" + msgId + "，已处理过");
    					return;
    				}
    				//正在处理
    				if (status.intValue() == ShopCode.SHOP_MQ_MESSAGE_STATUS_PROCESSING.getCode().intValue()) {
    					log.info("消息：" + msgId + ",正在处理");
    					return;
    				}
    				//处理失败
    				if (status.intValue() == ShopCode.SHOP_MQ_MESSAGE_STATUS_FAIL.getCode().intValue()) {
    					//获取处理次数
    					Integer times = mqConsumerLog.getConsumerTimes();
    					if (times > 5) {
    						log.info("消息：" + msgId + ",消息处理超过5次，不能在进行处理");
    						return;
    					}
    					//未超过5次，先更改消息处理状态
    					mqConsumerLog.setConsumerStatus(ShopCode.SHOP_MQ_MESSAGE_STATUS_PROCESSING.getCode());
    					//使用数据库乐观锁更新
    					LambdaQueryWrapper<MqConsumerLog> mqlqw = new LambdaQueryWrapper<>();
    					mqlqw.eq(MqConsumerLog::getMsgKey, mqConsumerLog.getMsgKey())
    							.eq(MqConsumerLog::getMsgTag, mqConsumerLog.getMsgTag())
    							.eq(MqConsumerLog::getGroupName, mqConsumerLog.getGroupName())
    							.eq(MqConsumerLog::getConsumerTimes, mqConsumerLog.getConsumerTimes());
    					int i = mqConsumerLogMapper.update(mqConsumerLog, mqlqw);
    					if (i <= 0) {
    						//发修改，未修改成功，稍后处理
    						log.error("消息：" + msgId + "并发修改，未修改成功，稍后处理");
    					}
    				}
    			} else {//没有消费过
    				mqConsumerLog = new MqConsumerLog();
    				mqConsumerLog.setConsumerStatus(ShopCode.SHOP_MQ_MESSAGE_STATUS_PROCESSING.getCode());
    				mqConsumerLog.setGroupName(groupName);
    				mqConsumerLog.setMsgBody(body);
    				mqConsumerLog.setMsgKey(keys);
    				mqConsumerLog.setMsgTag(tags);
    				mqConsumerLog.setConsumerTimes(0);
    				mqConsumerLog.setMsgId(msgId);

    				mqConsumerLogMapper.insert(mqConsumerLog);
    			}
    			//回退库存
    			MQEntity mqEntity = JSON.parseObject(body, MQEntity.class);
    			Long goodsId = mqEntity.getGoodsId();
    			Goods goods = goodsMapper.selectById(goodsId);
    			goods.setGoodsNumber(goods.getGoodsNumber() + mqEntity.getGoodsNum());
    			goodsMapper.updateById(goods);
    			//修改消息处理状态为成功
    			mqConsumerLog.setConsumerStatus(ShopCode.SHOP_MQ_MESSAGE_STATUS_SUCCESS.getCode());
    			mqConsumerLog.setConsumerTimestamp(LocalDateTime.now());
    			mqConsumerLog.setRemark("订单取消");
    			mqConsumerLogMapper.updateById(mqConsumerLog);
    			log.info("回退库存成功");
    		} catch (Exception e) {
    			e.printStackTrace();
    			LambdaQueryWrapper<MqConsumerLog> lqw = new LambdaQueryWrapper<>();
    			lqw.eq(MqConsumerLog ::getMsgTag,tags)
    					.eq(MqConsumerLog ::getGroupName,groupName)
    					.eq(MqConsumerLog::getMsgKey,keys);
    			MqConsumerLog mqConsumerLog = mqConsumerLogMapper.selectOne(lqw);
    			if (mqConsumerLog == null) {
    				//数据库未记录
    				mqConsumerLog = new MqConsumerLog();
    				mqConsumerLog.setMsgTag(tags);
    				mqConsumerLog.setGroupName(groupName);
    				mqConsumerLog.setMsgKey(keys);
    				mqConsumerLog.setConsumerStatus(ShopCode.SHOP_MQ_MESSAGE_STATUS_FAIL.getCode());
    				mqConsumerLog.setMsgBody(body);
    				mqConsumerLog.setConsumerTimes(1);
    				mqConsumerLogMapper.insert(mqConsumerLog);
    			}else {
    			    mqConsumerLog.setConsumerTimes(mqConsumerLog.getConsumerTimes() + 1);
    				mqConsumerLogMapper.updateById(mqConsumerLog);
    			}
    		}
    	}
    }
    ```

*   回退优惠券

    ```java
    @Slf4j
    @Component
    @RocketMQMessageListener(topic = "${mq.order.topic}",consumerGroup = "${mq.order.consumer.group.name}",messageModel = MessageModel.BROADCASTING)
    public class CancelMQListener implements RocketMQListener<MessageExt> {
    	@Autowired
    	private CouponMapper couponMapper;

    	@Override
    	public void onMessage(MessageExt messageExt) {
    		try {
    			String body = new String(messageExt.getBody());
    			MQEntity mqEntity = JSON.parseObject(body, MQEntity.class);
    			//使用优惠券才回退
    			if (mqEntity.getCouponId() != null) {
    				Coupon coupon = couponMapper.selectById(mqEntity.getCouponId());
    				coupon.setIsUsed(ShopCode.SHOP_COUPON_UNUSED.getCode());
    				coupon.setOrderId(null);
    				coupon.setUsedTime(null);
    				couponMapper.updateById(coupon);
    			}
    			log.info("优惠券回退成功");
    		} catch (Exception e) {
    			e.printStackTrace();
    			log.error("优惠券回退失败");
    		}
    	}
    }
    ```

*   回退余额

    ```java
    @Slf4j
    @Component
    @RocketMQMessageListener(topic = "${mq.order.topic}",consumerGroup = "${mq.order.consumer.group.name}",messageModel = MessageModel.BROADCASTING)
    public class CancelMQListener implements RocketMQListener<MessageExt> {

    	@Autowired
    	private IUserService userService;
    	@Override
    	public void onMessage(MessageExt messageExt) {
    		try {
    			String body = new String(messageExt.getBody());
    			MQEntity mqEntity = JSON.parseObject(body, MQEntity.class);
    			if (mqEntity.getUserId() != null && mqEntity.getUseMoney().compareTo(BigDecimal.ZERO)> 0) {
    				UserMoneyLog userMoneyLog = new UserMoneyLog();
    				userMoneyLog.setUseMoney(mqEntity.getUseMoney());
    				userMoneyLog.setMoneyLogType(ShopCode.SHOP_USER_MONEY_REFUND.getCode());
    				userMoneyLog.setUserId(mqEntity.getUserId());
    				userMoneyLog.setOrderId(mqEntity.getOrderId());
    				userService.updateMoneyPaid(userMoneyLog);
    				log.info("余额回退成功");
    			}
    		} catch (Exception e) {
    			e.printStackTrace();
    			log.error("余额回退失败");
    		}
    	}
    }
    ```

#### 测试--同上

*   报错

    *   There is no getter for property named 'null' in ####

        **pojo类缺少主键注解@TableId**

## 支付业务
