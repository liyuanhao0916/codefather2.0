# 好客租房

## 准备工作

### 安装准备

*   安装node.js  `node -v #查看`

*   安装yarn --- 其中tyarn使用的是npm.taobao.org的源，速度要快一些，可以把yarn看做了优化了的npm

    ```sh
    npm i yarn tyarn -g #-g 是指全局安装
    tyarn -v #进行测试，如果能够正常输出版本信息则说明安装成功了
    ```

    > 如果安装失败，是由于将yarn添加到环境变量中导致，参见
    > <http://www.easysb.cn/index.php/2017/06/04/11/>

*   安装umi

    ```sh
    tyarn global add umi
    umi #进行测试
    ```

### 工程准备

*   导入前端页面

*   导入相关依赖

    ```java
    tyarn install #安装相关依赖
    tyarn start #启动服务
    ```

    > 安装依赖报错Integrity check failed for “antd“ computed integrity doesn‘t match our records
    >
    >     yarn --update-checksums
    >
    > 报The engine "node" is incompatible with this module. Expected version XXX
    >
    > *   卸载重装高版本node.js

### 简单修改

*   改logo

    *   查看src/layouts/BasicLayout.js，发现页面左侧的菜单是自定义组件

        ```js
        import React from 'react';
        import { Layout } from 'antd';
        import DocumentTitle from 'react-document-title';
        import isEqual from 'lodash/isEqual';
        import memoizeOne from 'memoize-one';
        import { connect } from 'dva';
        import { ContainerQuery } from 'react-container-query';
        import classNames from 'classnames';
        import pathToRegexp from 'path-to-regexp';
        import { enquireScreen, unenquireScreen } from 'enquire-js';
        import { formatMessage } from 'umi/locale';
        import SiderMenu from '@/components/SiderMenu';	//左侧菜单栏
        import Authorized from '@/utils/Authorized';
        import SettingDrawer from '@/components/SettingDrawer';
        import logo from '../assets/logo-heima.png';
        import Footer from './Footer';					//版权信息
        import Header from './Header';
        import Context from './MenuContext';
        import Exception403 from '../pages/Exception/403';
        //...............
        {isTop && !isMobile ? null : (
          <SiderMenu
            logo={logo}
            Authorized={Authorized}
            theme={navTheme}
            onCollapse={this.handleMenuCollapse}
            menuData={menuData}
            isMobile={isMobile}
            {...this.props}
          />
        )}
        ```

    *   找到定义的文件（components/SiderMenu/SiderMenu.js）

        ```js
        return (
          <Sider
            trigger={null}
            collapsible
            collapsed={collapsed}
            breakpoint="lg"
            onCollapse={onCollapse}
            width={256}
            theme={theme}
            className={siderClassName}
          >
            <div className={styles.logo} id="logo">
              <Link to="/">
                {/* <img src={logo} alt="logo" /> */}
                <h1>好客租房 · 管理系统</h1>		//改logo
              </Link>
            </div>
            <BaseMenu
              {...this.props}
              mode="inline"
              handleOpenChange={this.handleOpenChange}
              onOpenChange={this.handleOpenChange}
              style={{ padding: '16px 0', width: '100%', overflowX: 'hidden' }}
              {...defaultProps}
            />
          </Sider>
        );
        ```

*   改版权 版本

    *   查看src/layouts/BasicLayout.js定位到Footer.js

    *   修改

        ```js
        import React, { Fragment } from 'react';
        import { Layout, Icon } from 'antd';
        import GlobalFooter from '@/components/GlobalFooter';

        const { Footer } = Layout;
        const FooterView = () => (
          <Footer style={{ padding: 0 }}>
            <GlobalFooter
              copyright={
                <Fragment>
                  Copyright <Icon type="copyright" /> 2018 黑马程序员 博学谷 出品
                </Fragment>
              }
            />
          </Footer>
        );
        export default FooterView;
        ```

*   编写左侧菜单栏

    *   config/router.config.js

        ```js
        export default [
          // app
          {
            path: '/',
            component: '../layouts/BasicLayout',
            Routes: ['src/pages/Authorized'],
            authority: ['admin', 'user'],
            routes: [

              { path: '/', redirect: '/dashboard/analysis' },	//重定向默认页面

              { //房源管理
                path: '/house',
                name: 'house',
                icon: 'home',
                routes: [
                  {
                    path: '/house/resource',
                    name: 'resource',
                    component: './haoke/House/Resource'
                  },
                  {
                    path: '/house/addResource',
                    name: 'addResource',
                    component: './haoke/House/AddResource'
                  },......
        ```

### 部署

*   jdk --- zookeeper
*   tomcat --- dubbo-admin
*   docker --- mysql

### 创建模块

#### 父模块

*   创建itcast-haoke-manage工程

*   引入依赖

    ```xml
     <dependencies>
        <!--springboot 测试支持-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        <!--dubbo的springboot支持-->
        <dependency>
            <groupId>com.alibaba.boot</groupId>
            <artifactId>dubbo-spring-boot-starter</artifactId>
            <version>0.2.0</version>
        </dependency>
        <!--dubbo框架-->
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>dubbo</artifactId>
            <version>2.6.4</version>
        </dependency>
        <!--String工具包-->
        <dependency>
            <groupId>org.apache.commons</groupId>
            <artifactId>commons-lang3</artifactId>
            <version>3.7</version>
        </dependency>
        <!--zk依赖-->
        <dependency>
            <groupId>org.apache.zookeeper</groupId>
            <artifactId>zookeeper</artifactId>
            <version>3.8.0</version>
        </dependency>
        <dependency>
            <groupId>com.github.sgroschupf</groupId>
            <artifactId>zkclient</artifactId>
            <version>0.1</version>
        </dependency>
        <!--腾讯云COS-->
        <dependency>
            <groupId>com.qcloud</groupId>
            <artifactId>cos_api</artifactId>
            <version>5.6.89</version>
        </dependency>
         <!--lombok-->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <version>1.18.10</version>
        </dependency>
    </dependencies>
    ```

#### 消费模块

*   itcast-haoke-manage-api

    ```xml
    <dependencies>
        <dependency>
                <groupId>org.example</groupId>
                <artifactId>itcast-haoke-manage-dubbo-server-house-resources-dubbo-interface</artifactId>
                <version>1.0-SNAPSHOT</version>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.example</groupId>
            <artifactId>itcast-haoke-manage-dubbo-server-common</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>
    </dependencies>
    ```

#### dubbo模块

*   创建itcast-haoke-manage-dubbo-server工程

*   引入依赖

    ```xml
    <dependencies>
        <!--Spring-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter</artifactId>
        </dependency>
        <!--mybatis-plus-->
        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-boot-starter</artifactId>
            <version>3.0.5</version>
        </dependency>
        <!--mysql-->
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <version>8.0.30</version>
            <optional>true</optional>
        </dependency>
        <!--jdbc-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-jdbc</artifactId>
        </dependency>
    </dependencies>
    ```

*   **子模块：common模块**

    > pojo
    >
    > vo
    >
    > service.BaseService

*   对每个**服务**创建**子模块**

    *   房源 -- 创建itcast-haoke-manage-dubbo-server-house-resources工程

    *   引入依赖

        ```xml
        <dependencies>
            <dependency>
                <groupId>org.example</groupId>
                <artifactId>itcast-haoke-manage-dubbo-server-common</artifactId>
                <version>1.0-SNAPSHOT</version>
            </dependency>
        </dependencies>
        ```

    *   对每个**功能**的*接口*和*实现类*创建相应的**子模块**

        *   itcast-haoke-manage-dubbo-server-house-resources-dubbo-interface

            > 对外提供的sdk包
            > 只提供接口，不提供实现类

        *   itcast-haoke-manage-dubbo-server-house-resources-dubbo-service

            > 具体Dubbo实现类、Spring的接口及实现类

            ```xml
            <dependencies>
                <dependency>
                    <groupId>org.example</groupId>
                    <artifactId>itcast-haoke-manage-dubbo-server-house-resources-dubbo-interface</artifactId>
                    <version>1.0-SNAPSHOT</version>
                </dependency>
            </dependencies>
            ```

#### sql

*   tb\_estate（楼盘表）

    ```sql
    CREATE TABLE `tb_estate` (
      `id` bigint(20) NOT NULL AUTO_INCREMENT,
      `name` varchar(100) DEFAULT NULL COMMENT '楼盘名称',
      `province` varchar(10) DEFAULT NULL COMMENT '所在省',
      `city` varchar(10) DEFAULT NULL COMMENT '所在市',
      `area` varchar(10) DEFAULT NULL COMMENT '所在区',
      `address` varchar(100) DEFAULT NULL COMMENT '具体地址',
      `year` varchar(10) DEFAULT NULL COMMENT '建筑年代',
      `type` varchar(10) DEFAULT NULL COMMENT '建筑类型',
      `property_cost` varchar(10) DEFAULT NULL COMMENT '物业费',
      `property_company` varchar(20) DEFAULT NULL COMMENT '物业公司',
      `developers` varchar(20) DEFAULT NULL COMMENT '开发商',
      `created` datetime DEFAULT NULL COMMENT '创建时间',
      `updated` datetime DEFAULT NULL COMMENT '更新时间',
      PRIMARY KEY (`id`)
    ) ENGINE=InnoDB AUTO_INCREMENT=1006 DEFAULT CHARSET=utf8 COMMENT='楼盘表';

    -- 初始数据
    INSERT INTO `tb_estate` (`id`, `name`, `province`, `city`, `area`, `address`, `year`, `type`, `property_cost`, `property_company`, `developers`, `created`, `updated`) VALUES ('1001', '中远两湾城', '上海市', '上海市', '普陀区', '远景路97弄', '2001', '塔楼/板楼', '1.5', '上海中远物业管理发展有限公司', '上海万业企业股份有限公司', '2018-11-06 23:00:20', '2018-11-06 23:00:23');
    INSERT INTO `tb_estate` (`id`, `name`, `province`, `city`, `area`, `address`, `year`, `type`, `property_cost`, `property_company`, `developers`, `created`, `updated`) VALUES ('1002', '上海康城', '上海市', '上海市', '闵行区', '莘松路958弄', '2001', '塔楼/板楼', '1.5', '盛孚物业', '闵行房地产', '2018-11-06 23:02:30', '2018-11-27 23:02:33');
    INSERT INTO `tb_estate` (`id`, `name`, `province`, `city`, `area`, `address`, `year`, `type`, `property_cost`, `property_company`, `developers`, `created`, `updated`) VALUES ('1003', '保利西子湾', '上海市', '上海市', '松江区', '广富林路1188弄', '2008', '塔楼/板楼', '1.75', '上海保利物业管理', '上海城乾房地产开发有限公司', '2018-11-06 23:04:22', '2018-11-06 23:04:25');
    INSERT INTO `tb_estate` (`id`, `name`, `province`, `city`, `area`, `address`, `year`, `type`, `property_cost`, `property_company`, `developers`, `created`, `updated`) VALUES ('1004', '万科城市花园', '上海市', '上海市', '松江区', '广富林路1188弄', '2002', '塔楼/板楼', '1.5', '上海保利物业管理', '上海城乾房地产开发有限公司', '2018-11-13 16:43:40', '2018-11-13 16:43:42');
    INSERT INTO `tb_estate` (`id`, `name`, `province`, `city`, `area`, `address`, `year`, `type`, `property_cost`, `property_company`, `developers`, `created`, `updated`) VALUES ('1005', '上海阳城', '上海市', '上海市', '闵行区', '罗锦路888弄', '2002', '塔楼/板楼', '1.5', '上海莲阳物业管理有限公司', '上海莲城房地产开发有限公司', '2018-11-06 23:23:52', '2018-11-06 23:23:55');
    ```

*   tb\_house\_resources（房源表）

    ```sql
    CREATE TABLE `tb_house_resources` (
      `id` bigint(20) NOT NULL AUTO_INCREMENT,
      `title` varchar(100) DEFAULT NULL COMMENT '房源标题',
      `estate_id` bigint(20) DEFAULT NULL COMMENT '楼盘id',
      `building_num` varchar(5) DEFAULT NULL COMMENT '楼号（栋）',
      `building_unit` varchar(5) DEFAULT NULL COMMENT '单元号',
      `building_floor_num` varchar(5) DEFAULT NULL COMMENT '门牌号',
      `rent` int(10) DEFAULT NULL COMMENT '租金',
      `rent_method` tinyint(1) DEFAULT NULL COMMENT '租赁方式，1-整租，2-合租',
      `payment_method` tinyint(1) DEFAULT NULL COMMENT '支付方式，1-付一押一，2-付三押一，3-付六押一，4-年付押一，5-其它',
      `house_type` varchar(255) DEFAULT NULL COMMENT '户型，如：2室1厅1卫',
      `covered_area` varchar(10) DEFAULT NULL COMMENT '建筑面积',
      `use_area` varchar(10) DEFAULT NULL COMMENT '使用面积',
      `floor` varchar(10) DEFAULT NULL COMMENT '楼层，如：8/26',
      `orientation` varchar(2) DEFAULT NULL COMMENT '朝向：东、南、西、北',
      `decoration` tinyint(1) DEFAULT NULL COMMENT '装修，1-精装，2-简装，3-毛坯',
      `facilities` varchar(50) DEFAULT NULL COMMENT '配套设施， 如：1,2,3',
      `pic` varchar(200) DEFAULT NULL COMMENT '图片，最多5张',
      `house_desc` varchar(200) DEFAULT NULL COMMENT '描述',
      `contact` varchar(10) DEFAULT NULL COMMENT '联系人',
      `mobile` varchar(11) DEFAULT NULL COMMENT '手机号',
      `time` tinyint(1) DEFAULT NULL COMMENT '看房时间，1-上午，2-中午，3-下午，4-晚上，5-全天',
      `property_cost` varchar(10) DEFAULT NULL COMMENT '物业费',
      `created` datetime DEFAULT NULL,
      `updated` datetime DEFAULT NULL,
      PRIMARY KEY (`id`)
    ) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COMMENT='房源表';
    ```

#### 代码生成器

*   随便创建一个工程 --- 如Dubbo模块下itcast-haoke-manage-dubbo-server-generator工程

*   引入依赖

    ```xml
    <parent>
        <artifactId>itcast-haoke-manage-dubbo-server</artifactId>
        <groupId>cn.itcast.haoke</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>

    <dependencies>
        <!-- freemarker 模板引擎 -->
        <dependency>
            <groupId>org.freemarker</groupId>
            <artifactId>freemarker</artifactId>
            <version>2.3.28</version>
        </dependency>
    </dependencies>
    ```

*   代码

    ```java
    public class CodeGenerator {
        /**
        * 读取控制台内容
        */
        public static String scanner(String tip) {
            Scanner scanner = new Scanner(System.in);
            StringBuilder help = new StringBuilder();
            help.append("请输入" + tip + "：");
            System.out.println(help.toString());
            if (scanner.hasNext()) {
                String ipt = scanner.next();
                if (StringUtils.isNotEmpty(ipt)) {
                	return ipt;
                }
            }
            throw new MybatisPlusException("请输入正确的" + tip + "！");
        }
        
        public static void main(String[] args) {
            // 代码生成器
            AutoGenerator mpg = new AutoGenerator();
            // 全局配置
            GlobalConfig gc = new GlobalConfig();
            String projectPath = System.getProperty("user.dir");
            gc.setOutputDir(projectPath + "/src/main/java");
            gc.setAuthor("itcast");
            gc.setOpen(false);
            mpg.setGlobalConfig(gc);
            // 数据源配置
            DataSourceConfig dsc = new DataSourceConfig();
            dsc.setUrl("jdbc:mysql://172.16.55.185:3306/haoke?useUnicode=true&characterEncoding=utf8&autoReconnect=true&allowMultiQueries=true");
            // dsc.setSchemaName("public");
            dsc.setDriverName("com.mysql.jdbc.Driver");
            dsc.setUsername("root");
            dsc.setPassword("root");
            mpg.setDataSource(dsc);
            // 包配置
            PackageConfig pc = new PackageConfig();
            pc.setModuleName(scanner("模块名"));
            pc.setParent("cn.itcast.haoke.dubbo.server");
            mpg.setPackageInfo(pc);
            // 自定义配置
            InjectionConfig cfg = new InjectionConfig() {
                @Override
                public void initMap() {
                // to do nothing
                }
            };
            List<FileOutConfig> focList = new ArrayList<>();
            focList.add(new FileOutConfig("/templates/mapper.xml.ftl") {
                @Override
                public String outputFile(TableInfo tableInfo) {
                    // 自定义输入文件名称
                    return projectPath + "/src/main/resources/mapper/" + pc.getModuleName() + "/" + tableInfo.getEntityName() + "Mapper" + StringPool.DOT_XML;
                }
            });
            cfg.setFileOutConfigList(focList);
            mpg.setCfg(cfg);
            mpg.setTemplate(new TemplateConfig().setXml(null));
            // 策略配置
            StrategyConfig strategy = new StrategyConfig();
            strategy.setNaming(NamingStrategy.underline_to_camel);
            strategy.setColumnNaming(NamingStrategy.underline_to_camel);
            strategy.setSuperEntityClass("cn.itcast.haoke.dubbo.server.pojo.BasePojo");
            strategy.setEntityLombokModel(true);
            strategy.setRestControllerStyle(true);       //strategy.setSuperControllerClass("com.baomidou.ant.common.BaseController");
            strategy.setInclude(scanner("表名"));
            strategy.setSuperEntityColumns("id");
            strategy.setControllerMappingHyphenStyle(true);
            strategy.setTablePrefix(pc.getModuleName() + "_");
            mpg.setStrategy(strategy);
            mpg.setTemplateEngine(new FreemarkerTemplateEngine());
            mpg.execute();
        }
    }
    ```

*   运行，输入

        houseResources
        tb_house_resources

*   一般只需要pojo，pojo文件拷贝到itcast-haoke-manage-dubbo-server-common工程

    *   @EqualsAndHashCode(callSuper = true)**去掉**

    *   @TableName("tb\_house\_resources")**指定表名**

    *   删除继承父类的属性

    *   生成真正的serialVersionUID

    *   补全属性

        ```java
        @TableId(value = "id",type = IdType.AUTO)
        private Long id;
        ```

    *   修改一些Boolean类型 为Integer

#### 总结

*   模块

    ![image-20220928001924557](http://minio.botuer.com/study-node/old/image-20220928001924557.png)

*   依赖

    *   父 -- spring-boot-starter-parent、spring-boot-starter-test、dubbo-spring-boot-starter、dubbo、commons-lang3、zookeeper、zkclient
        *   消费者 -- spring-boot-starter-web、接口模块
        *   提供者 -- spring-boot-starter
            *   服务模块 -- lombok、mybatis-plus-boot-starter、mysql-connector-java
                *   接口模块
                *   实现模块 -- spring-boot-starter-jdbc、接口模块

*   关系

    ![image-20220928012301437](http://minio.botuer.com/study-node/old/image-20220928012301437.png)

    **如果需要更换技术，只需要更改Dubbo api中的实现类**

        公共模块 --- pojo、vo、service（BaseService实现类）
        服务模块 --- 接口模块、实现模块
            接口模块 --- api（仅接口Apixxxxxx）
            实现模块 --- mapper（继承BaseMapper）、
                    --- config（MybatisPlusConfig）、
                    --- service（Spring）、
                        --- impl（具体实现类）
                    --- api（实现Dubbo服务 --- 实现Apixxxxxx）
                    启动类
                    配置文件

        消费模块 --- service（对Apixxxxxx的运程调用）
        		--- controller（调用service进行controller）
        		启动类
        		配置文件

## 后端开发

### 新增房源

#### dubbo服务

*   在itcast-haoke-manage-dubbo-server-house-resources-dubbo-interface工程

    ```java
    package cn.itcast.haoke.dubbo.server.api;

    public interface ApiHouseResourcesService {
        /**
         *
         * @param houseResources
         *
         * @return -1:输入的参数不符合要求，0：数据插入数据库失败，1：成功
         */
        int saveHouseResources(HouseResources houseResources);
    }
    ```

#### Spring实现

*   在itcast-haoke-manage-dubbo-server-house-resources-dubbo-service工程

*   编写application.properties配置文件

    ```properties
    ## Spring boot application
    spring.application.name = itcast-haoke-manage-dubbo-server-house-resources
    ## 数据库
    spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
    spring.datasource.url=jdbc:mysql://42.193.100.99:3306/haoke?useUnicode=true&characterEncoding=utf8&autoReconnect=true&allowMultiQueries=true&useSSL=false
    spring.datasource.username=root
    spring.datasource.password=root

    dubbo.scan.basePackages=cn.itcast.haoke.dubbo.server.api
    ## 应用名称
    dubbo.application.name=dubbo-provider-house-resources
    ## 协议以及端口
    dubbo.protocol.name=dubbo
    dubbo.protocol.port=20880
    ## zk注册中心
    dubbo.registry.address=zookeeper://42.193.100.99:2181;zookeeper://42.193.100.99:2182;zookeeper://42.193.100.99:2183
    dubbo.registry.client=zkclient

    spring.dubbo.server=true
    ```

*   编写HouseResourcesMapper接口

    ```java
    package cn.itcast.haoke.dubbo.server.mapper;

    public interface HouseResourcesMapper extends BaseMapper<HouseResources> {
    }
    ```

*   编写MybatisPlus配置类

    ```java
    package cn.itcast.haoke.dubbo.server.config;

    @MapperScan("cn.itcast.haoke.dubbo.server.mapper")
    @Configuration
    public class MybatisConfig {
    }
    ```

*   编写service

    > 这里编写的Service是Spring的service，不是dubbo服务，因为需要控制事务以及一些逻辑

    ```java
    package cn.itcast.haoke.dubbo.server.service;

    public interface HouseResourcesService {
        /**
         *
         * @param houseResources
         *
         * @return -1:输入的参数不符合要求，0：数据插入数据库失败，1：成功
         */
        int saveHouseResources(HouseResources houseResources);
    }
    ```

    ```java
    //BaseService实现类
    package cn.itcast.haoke.dubbo.server.service.impl;

    public abstract class BaseServiceImpl<T extends BasePojo> {

        @Autowired
        private BaseMapper<T> mapper;

        /**
         * 根据id查询数据
         * @param id
         * @return
         */
        public T queryById(Long id) {
            return this.mapper.selectById(id);
        }

        /**
         * 查询所有数据
         * @return
         */
        public List<T> queryAll() {
            return this.mapper.selectList(null);
        }

        /**
         * 根据条件查询一条数据
         * @param record
         * @return
         */
        public T queryOne(T record) {
            return this.mapper.selectOne(new QueryWrapper<>(record));
        }

        /**
         * 根据条件查询数据列表
         * @param record
         * @return
         */
        public List<T> queryListByWhere(T record) {
            return this.mapper.selectList(new QueryWrapper<>(record));
        }

        /**
         * 根据条件分页查询数据列表
         * @param record
         * @param page
         * @param rows
         * @return
         */
        public IPage<T> queryPageListByWhere(T record, Integer page, Integer rows) {
            // 获取分页数据
            return this.mapper.selectPage(new Page<T>(page, rows), new QueryWrapper<>
                    (record));
        }

        /**
         * 保存数据
         * @param record
         * @return
         */
        public Integer save(T record) {
            record.setCreated(new Date());
            record.setUpdated(record.getCreated());
            return this.mapper.insert(record);
        }

        /**
         * 更新数据
         * @param record
         * @return
         */
        public Integer update(T record) {
            record.setUpdated(new Date());
            return this.mapper.updateById(record);
        }

        /**
         * 根据id删除数据
         * @param id
         * @return
         */
        public Integer deleteById(Long id) {
            return this.mapper.deleteById(id);
        }

        /**
         * 根据ids批量删除数据
         * @param ids
         * @return
         */
        public Integer deleteByIds(List<Long> ids) {
            return this.mapper.deleteBatchIds(ids);
        }

        /**
         * 根据条件删除数据
         * @param record
         * @return
         */
        public Integer deleteByWhere(T record) {
            return this.mapper.delete(new QueryWrapper<>(record));
        }

    }
    ```

    ```java
    //具体实现类
    package cn.itcast.haoke.dubbo.server.service.impl;

    @Service
    @Transactional
    public class HouseResourcesServiceImpl extends BaseServiceImpl implements HouseResourcesService {
        @Override
        public int saveHouseResources(HouseResources houseResources) {
            // 编写校验逻辑，如果教研不通过，返回-1
            if (StringUtils.isBlank(houseResources.getTitle())) {
                return -1;
            }
            // 其他校验以及逻辑省略 ……
            return super.save(houseResources);

        }
    }
    ```

#### Dubbo实现

```java
package cn.itcast.haoke.dubbo.server.api;

@Service(version ="1.0.0") // 这是dubbo服务，对外进行暴露
public class ApiHouseResourcesServiceImpl implements ApiHouseResourcesService{

    @Autowired
    private HouseResourcesService houseResourcesService;
    @Override
    public int saveHouseResources(HouseResources houseResources) {
        return this.houseResourcesService.saveHouseResources(houseResources);
    }
}
```

*   启动类

    ```java
    package cn.itcast.haoke.dubbo.server;

    @SpringBootApplication
    public class DubboProvider {
        public static void main(String[] args) {
            new SpringApplicationBuilder(DubboProvider.class)
                    .web(WebApplicationType.NONE) // 非 Web 应用
                    .run(args);
        }
    }
    ```

*   测试 --- 启动，在dubbo-admin观察

#### RESTful实现

*   itcast-haoke-manage-api-server工程是，为前端系统提供接口服务，是dubbo服务的消费方。

*   添加依赖  itcast-haoke-manage-dubbo-server-house-resources-dubbo-interface

*   编写service编写service

    > HouseResourcesService用于调用dubbo服务

    ```java
    package cn.itcast.haoke.dubbo.api.service;

    @Service
    public class HouseResourcesService {
        @Reference(version = "1.0.0")
        private ApiHouseResourcesService apiHouseResourcesService;
        public boolean save(HouseResources houseResources){
            int result =this.apiHouseResourcesService.saveHouseResources(houseResources);
            return result == 1;
        }
    }
    ```

*   编写controller

    ```java
    package cn.itcast.haoke.dubbo.api.controller;

    @Controller
    @RequestMapping("house/resources")
    public class HouseResourcesController {
        @Autowired
        private HouseResourcesService houseResourcesService;

        /**
         * 新增房源
         *
         * @param houseResources json数据
         * @return
         */
        @PostMapping
        @ResponseBody
        public ResponseEntity<Void> save(@RequestBody HouseResources houseResources) {
            try {
                boolean bool = this.houseResourcesService.save(houseResources);
                if (bool) {
                    return ResponseEntity.status(HttpStatus.CREATED).build();
                }
            } catch (Exception e) {
                e.printStackTrace();
            }
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build();
        }

        /**
         * test
         *
         * @return
         */
        @GetMapping
        @ResponseBody
        public ResponseEntity<String> get() {
            return ResponseEntity.ok("ok");
        }
    }
    ```

*   编写启动类

    ```java
    package cn.itcast.haoke.dubbo.api;

    @SpringBootApplication
    public class DubboApiApplication {
        public static void main(String[] args) {
            SpringApplication.run(DubboApiApplication.class, args);
        }
    }
    ```

*   编写application.properties配置文件

    ```properties
    ## Spring boot application
    spring.application.name = itcast-haoke-manage-dubbo-server-house-resources

    ## 应用名称
    dubbo.application.name = dubbo-consumer-haoke-manage
    server.port = 18080
    #logging.level.root=DEBUG

    ## zk注册中心
    dubbo.registry.address=zookeeper://42.193.100.99:2181;zookeeper://42.193.100.99:2182;zookeeper://42.193.100.99:2183
    dubbo.registry.client=zkclient
    ```

*   运行启动服务，测试

    ```json
    {
      "title": "东方曼哈顿 3室2厅 16000元",
      "buildingNum": "2",
      "buildingUnit": "1",
      "buildingFloorNum": "1",
      "rent": "1111",
      "paymentMethod": "1",
      "rentMethod": "1",
      "coveredArea": "2",
      "useArea": "2",
      "orientation": "南",
      "decoration": "1",
      "facilities": "1,2,3,8,9",
      "houseDesc": "这个经纪人很懒，没写核心卖点",
      "contact": "张三",
      "mobile": "11111111111",
      "time": "1",
      "propertyCost": "11",
      "floor": "1/2",
      "houseType": "1室1厅1卫1厨1阳台",
      "estateId": "1005"
    }
    ```

### 腾讯云COS对象存储

#### 依赖

*   父模块下

```xml
<dependency>
    <groupId>com.qcloud</groupId>
    <artifactId>cos_api</artifactId>
    <version>5.6.89</version>
</dependency>
```

#### 配置文件

*   消费者模块下

```properties
COS.secretId=AKIDDH5cssb2C6j6C0YppY1C6jW3JI0RbU6S
COS.secretKey=6vSjjRt4ybx1oKZXFgqjLhma7NM4VgaD
COS.appId=1253920081
#桶id
COS.bucketName=haoke-1253920081
#地域
COS.region=ap-beijing
#域名
COS.url=https://haoke-1253920081.cos.ap-beijing.myqcloud.com
#文件目录前缀
COS.prefix=/images
```

#### COSConfig

*   属性注入
*   COSClient交由IOC容器管理

```java
package cn.itcast.haoke.dubbo.api.config;

@Data
@ConfigurationProperties(prefix = "cos")
@Configuration
public class COSConfig {
    private String url;
    private String secretId;
    private String secretKey;
    private String region;
    private String bucketName;
    private String prefix;

    @Bean
    public COSClient cosClient() {
        //初始化用户信息
        COSCredentials cosCredentials = new BasicCOSCredentials(this.secretId,this.secretKey);
        //设置地域
        Region region = new Region(this.region);
        ClientConfig config = new ClientConfig(region);
        //生成COS客户端
        COSClient client = new COSClient(cosCredentials,config);
        return client;

    }
}
```

#### PicUploadResult

*   定义上传结果类

```java
package cn.itcast.haoke.dubbo.api.vo;

@Data
public class PicUploadResult {

    // 文件唯一标识
    private String uid;
    // 文件名
    private String name;
    // 状态有：uploading done error removed
    private String status;
    // 服务端响应内容，如：'{"status": "success"}'
    private String response;

}
```

#### PicUploadService

```java
package cn.itcast.haoke.dubbo.api.service;

@Service
public class PicUploadService {
    // 允许上传的格式
    private static final String[] IMAGE_TYPE = new String[]{".bmp", ".jpg", ".jpeg", ".gif", ".png" };

    @Autowired
    private COSClient cosClient;
    @Autowired
    private COSConfig cosConfig;

    public PicUploadResult upload(MultipartFile uploadFile) {
        // 校验图片格式
        boolean isLegal = false;
        for (String type : IMAGE_TYPE){
            if (StringUtils.endsWithIgnoreCase(uploadFile.getOriginalFilename(),type)) {
                isLegal = true;
                break;
            }
        }
        // 封装Result对象，并且将文件的byte数组放置到result对象中
        PicUploadResult picUploadResult = new PicUploadResult();
        if (!isLegal) {
            picUploadResult.setStatus("error");
            return picUploadResult;
        }

        // 文件新路径
        String fileName = uploadFile.getOriginalFilename();
        String filePath = getFilePath(fileName);
        //元数据设置流的大小
        ObjectMetadata objectMetadata = new ObjectMetadata();
        objectMetadata.setContentLength(uploadFile.getSize());
		// 上传到腾讯云
        try {
            //PutObjectRequest构造参数：桶名、文件路径、文件流、文件元数据
            cosClient.putObject(new PutObjectRequest(cosConfig.getBucketName(),
                                   filePath,
                                   new ByteArrayInputStream(uploadFile.getBytes()),
                                   objectMetadata));
        } catch (IOException e) {
            e.printStackTrace();
            //上传失败
            picUploadResult.setStatus("error");
            return picUploadResult;
        }

        picUploadResult.setStatus("done");  //设置请求状态
        picUploadResult.setName(this.cosConfig.getUrl() + filePath);    //设置文件名
        picUploadResult.setUid(String.valueOf(System.currentTimeMillis())); //设置文件唯一标识
        return picUploadResult;
    }

    /**
     * 定义文件路径/images/年/月/日/时间戳+随机数.jpg
     * @param sourceFileName
     * @return
     */
    private String getFilePath(String sourceFileName) {
        DateTime dateTime = new DateTime();
        return cosConfig.getPrefix() + "/"
                + dateTime.toString("yyyy") + "/"
                + dateTime.toString("MM") + "/"
                + dateTime.toString("dd") + "/"
                + System.currentTimeMillis()
                + RandomUtils.nextInt(100, 9999) + "."
                + StringUtils.substringAfterLast(sourceFileName, ".");
    }
}
```

#### PicUploadController

```java
package cn.itcast.haoke.dubbo.api.controller;

@RestController
@RequestMapping("pic/upload")
public class PicUploadController {

    @Autowired
    private PicUploadService picUploadService;

    @PostMapping
    public PicUploadResult upload(@RequestParam("file") MultipartFile uploadFile)
            throws Exception {
        return this.picUploadService.upload(uploadFile);
    }
}
```

#### 测试

    http://127.0.0.1:18080/pic/upload
    Body --- form-data  key与参数名一致或与@RequestParam属性值一致 value选择图片

### 修改房源

*   controller

    ```java
    @PutMapping
    @ResponseBody
    public ResponseEntity<Void> update(@RequestBody HouseResources houseResources) {
        try {
            boolean bool = this.houseResourcesService.update(houseResources);
            if (bool) {
            	return ResponseEntity.status(HttpStatus.NO_CONTENT).build();
            }
        } catch (Exception e) {
        	e.printStackTrace();
        }
        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build();
    }
    ```

*   service

    ```java
    public boolean update(HouseResources houseResources) {
    	return this.apiHouseResourcesService.updateHouseResources(houseResources);
    }
    ```

*   dubbo服务

    ```java
    boolean updateHouseResources(HouseResources houseResources);
    ```

*   dubbo实现

    ```java
    public boolean updateHouseResources(HouseResources houseResources) {
    	return this.houseResourcesService.updateHouseResources(houseResources);
    }
    ```

*   spring接口

    ```java
    boolean updateHouseResources(HouseResources houseResources);
    ```

*   spring实现

    ```java
    @Override
    public boolean updateHouseResources(HouseResources houseResources) {
    	return super.update(houseResources) == 1;
    }
    ```

*   测试

    ```http
    //put
    http://127.0.0.1:18080/house/resources
    ```

    ```json
    {
      "id": 11,
      "title": "哈拉啦啦啦啦的",
      "buildingNum": "2",
      "buildingUnit": "1",
      "buildingFloorNum": "1",
      "rent": "1111",
      "paymentMethod": "1",
      "rentMethod": "1",
      "coveredArea": "2",
      "useArea": "2",
      "orientation": "北",
      "decoration": "1",
      "facilities": "1,2,3,8,9",
      "houseDesc": "这个经纪人很懒，没写核心卖点",
      "contact": "打断",
      "mobile": "15665111",
      "time": "1",
      "propertyCost": "11",
      "floor": "1/2",
      "houseType": "1室1厅1卫1厨1阳台",
      "estateId": "1005"
    }
    ```

### 房源列表

#### dubbo服务

```java
public interface ApiHouseResourcesService {
    /**
     *
     * @param houseResources
     *
     * @return -1:输入的参数不符合要求，0：数据插入数据库失败，1：成功
     */
    int saveHouseResources(HouseResources houseResources);

    /**
     *
     * @param currentPage  当前页
     * @param pageSize  每页多少条
     * @param queryCondition    查询条件
     * @return
     */
    PageInfo<HouseResources> queryHouseResourcesList(int currentPage, int pageSize, HouseResources queryCondition);

}
```

#### MyBatis-Plus分页插件

```java
@MapperScan("cn.itcast.haoke.dubbo.server.mapper")
@Configuration
public class MybatisConfig {

    /**
     * 分页插件
     * @return
     */
    @Bean
    public PaginationInterceptor paginationInterceptor() {
        return new PaginationInterceptor();
    }

}
```

#### Spring实现

*   service

```java
public interface HouseResourcesService {
    /**
     *
     * @param houseResources
     *
     * @return -1:输入的参数不符合要求，0：数据插入数据库失败，1：成功
     */
    int saveHouseResources(HouseResources houseResources);

    /**
     * 
     * @param page
     * @param pageSize
     * @param queryCondition
     * @return
     */
    PageInfo<HouseResources> queryHouseResourcesList(int page, int pageSize, HouseResources queryCondition);
}
```

*   impl

    *   BaseServiceImpl

        ```java
        public abstract class BaseServiceImpl<T extends BasePojo> {
            //........
            //........
        	public IPage<T> queryPageList(QueryWrapper<T> queryWrapper, Integer page, Integer rows) {
                // 获取分页数据
                return this.mapper.selectPage(new Page<T>(page, rows), queryWrapper);
            }
        }
        ```

    *   HouseResourcesServiceImpl

        ```java
        @Service
        @Transactional
        public class HouseResourcesServiceImpl extends BaseServiceImpl implements HouseResourcesService {
            @Override
            public int saveHouseResources(HouseResources houseResources) {
                // 编写校验逻辑，如果教研不通过，返回-1
                if (StringUtils.isBlank(houseResources.getTitle())) {
                    return -1;
                }
                // 其他校验以及逻辑省略 ……
                return super.save(houseResources);

            }

            @Override
            public PageInfo<HouseResources> queryHouseResourcesList(int page, int pageSize, HouseResources queryCondition) {
                QueryWrapper<Object> queryWrapper = new QueryWrapper<>(queryCondition);
                queryWrapper.orderByDesc("updated");
                IPage iPage = super.queryPageList(queryWrapper, page, pageSize);
                return new PageInfo<HouseResources>(Long.valueOf(iPage.getTotal()).intValue(),page,pageSize,iPage.getRecords());
            }
        }
        ```

#### Dubbo实现

```java
@Service(version ="1.0.0") // 这是dubbo服务，对外进行暴露
public class ApiHouseResourcesServiceImpl implements ApiHouseResourcesService{

    @Autowired
    private HouseResourcesService houseResourcesService;
    @Override
    public int saveHouseResources(HouseResources houseResources) {
        return this.houseResourcesService.saveHouseResources(houseResources);
    }

    @Override
    public PageInfo<HouseResources> queryHouseResourcesList(int page, int pageSize, HouseResources queryCondition) {
        return houseResourcesService.queryHouseResourcesList(page,pageSize,queryCondition);
    }
}
```

#### RESTful实现

*   Pagination“分页”

    ```java
    @Data
    @AllArgsConstructor
    public class Pagination {

        private Integer currentPage;
        private Integer pageSize;
        private Integer total;

    }
    ```

*   TableResult查询结果返回值

    ```java
    @Data
    @AllArgsConstructor
    public class TableResult <T>{

        private List<T> list;
        private Pagination pagination;

    }
    ```

*   service --- Dubbo引用

    ```java
    @Service
    public class HouseResourcesService {

        @Reference(version = "1.0.0")
        private ApiHouseResourcesService apiHouseResourcesService;

        public boolean save(HouseResources houseResources){
            int result =this.apiHouseResourcesService.saveHouseResources(houseResources);
            return result == 1;
        }

        public TableResult queryList(HouseResources houseResources, Integer currentPage, Integer pageSize) {
            PageInfo<HouseResources> pageInfo = this.apiHouseResourcesService.
                    queryHouseResourcesList(currentPage, pageSize, houseResources);

            return new TableResult(pageInfo.getRecords(),
                    new Pagination(currentPage, pageSize, pageInfo.getTotal()));

        }
    }
    ```

*   controller

    ```java
    @RestController
    @RequestMapping("house/resources")
    public class HouseResourcesController {
        @Autowired
        private HouseResourcesService houseResourcesService;

        /**
         * 新增房源
         *
         * @param houseResources json数据
         * @return
         */
        @PostMapping
        public ResponseEntity<Void> save(@RequestBody HouseResources houseResources) {
            try {
                boolean bool = this.houseResourcesService.save(houseResources);
                if (bool) {
                    return ResponseEntity.status(HttpStatus.CREATED).build();
                }
            } catch (Exception e) {
                e.printStackTrace();
            }
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build();
        }


        /**
         * 查询房源列表
         * @param houseResources
         * @param currentPage
         * @param pageSize
         * @return
         */
        @GetMapping
        @ResponseBody
        public ResponseEntity<TableResult> list(HouseResources houseResources,
                                                @RequestParam(name = "currentPage", defaultValue = "1") Integer currentPage,
                                                @RequestParam(name = "pageSize", defaultValue = "10") Integer pageSize) {
            return ResponseEntity.ok(this.houseResourcesService.queryList(houseResources, currentPage, pageSize));
        }

    }
    ```

### 查询房源

*   dubbo服务

    ```java
    HouseResources queryHouseResourcesById(Long id);
    ```

*   分页插件

*   Spring服务

    ```java
    HouseResources queryHouseResourcesById(Long id);
    ```

*   Spring实现

    ```java
    public HouseResources queryHouseResourcesById(Long id) {
        return super.queryById(id);
    }
    ```

*   Dubbo实现

    ```java
    @Override
    public HouseResources queryHouseResourcesById(Long id) {
        return this.houseResourcesService.queryHouseResourcesById(id);
    }
    ```

*   RESTful实现

    ```java
    public HouseResources getByID(Long query) {
        return apiHouseResourcesService.queryHouseResourcesById(query);
    }
    ```

    ```java
    /**
     * 根据id查房源
     * @param id 房源id
     * @return
     */
    @GetMapping("/{id}")
    public HouseResources getById(@PathVariable Long id){
        return  this.houseResourcesService.getByID(id);
    }
    ```

<hr>

### 轮播广告

*   数据库

    ```sql
    use haoke;

    CREATE TABLE `tb_ad` (
        `id` bigint(20) NOT NULL AUTO_INCREMENT,
        `type` int(10) DEFAULT NULL COMMENT '广告类型',
        `title` varchar(100) DEFAULT NULL COMMENT '描述',
        `url` varchar(200) DEFAULT NULL COMMENT '图片URL地址',
        `created` datetime DEFAULT NULL,
        `updated` datetime DEFAULT NULL,
        PRIMARY KEY (`id`)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='广告表';

    INSERT INTO `tb_ad` (`id`,`type`,`title`,`url`,`created`,`updated`) VALUES ('1','1','UniCity万科天空之城','https://haoke-1253920081.cos.ap-beijing.myqcloud.com/images/2022/09/29/16644567855393314.jpg','2018-11-26 11:28:49','2018-11-26 11:28:51');
    INSERT INTO `tb_ad` (`id`,`type`,`title`,`url`,`created`,`updated`) VALUES ('2','1','天和尚海庭前','https://haoke-1253920081.cos.ap-beijing.myqcloud.com/images/2022/09/29/16644575095789389.png','2018-11-26 11:29:27','2018-11-26 11:29:29');
    INSERT INTO `tb_ad` (`id`,`type`,`title`,`url`,`created`,`updated`) VALUES ('3','1','[奉贤 南桥] 光语著','https://haoke-1253920081.cos.ap-beijing.myqcloud.com/images/2022/09/29/16644575168817311.jpg','2018-11-26 11:30:04','2018-11-26 11:30:06');
    INSERT INTO `tb_ad` (`id`,`type`,`title`,`url`,`created`,`updated`) VALUES ('4','1','[上海周边 嘉兴] 融创海逸长洲','https://haoke-1253920081.cos.ap-beijing.myqcloud.com/images/2022/09/29/16644575209668589.jpg','2018-11-26 11:30:49','2018-11-26 11:30:53');
    ```

*   创建子服务工程itcast-haoke-manage-dubbo-server-ad依赖commen

    *   itcast-haoke-manage-dubbo-server-ad-interface
    *   itcast-haoke-manage-dubbo-server-ad-service依赖interface

*   pojo

    ```java
    package cn.itcast.haoke.dubbo.server.pojo;

    @Data
    @Accessors(chain = true)
    @TableName("tb_ad")
    public class Ad extends BasePojo {

        private static final long serialVersionUID = -1899817153726974690L;
        @TableId(value = "id", type = IdType.AUTO)
        private Long id;
        //广告类型
        private Integer type;
        //描述
        private String title;
        //'图片URL地址
        private String url;
    }
    ```

*   Dubbo服务

    ```java
    package cn.itcast.haoke.dubbo.server.api;

    public interface ApiAdService {
        /**
         * 分页查询广告数据
         *
         * @param type     广告类型
         * @param page     页数
         * @param pageSize 每页显示的数据条数
         * @return
         */
        PageInfo<Ad> queryAdList(Integer type, Integer page, Integer pageSize);
    }
    ```

*   Spring实现

    ```java
    public interface AdMapper extends BaseMapper<Ad> {
    }
    ```

    ```java
    public interface AdService {
        PageInfo<Ad> queryAdList(Ad ad, Integer page, Integer pageSize);
    }
    ```

    ```java
    @Service
    public class ADServiceImpl extends BaseServiceImpl<Ad> implements AdService {

        @Override
        public PageInfo<Ad> queryAdList(Ad ad, Integer page, Integer pageSize) {
            IPage<Ad> iPage = super.queryPageListByWhere(ad, page, pageSize);
            return new PageInfo<>(Long.valueOf(iPage.getTotal()).intValue(),page,pageSize,iPage.getRecords());
        }
    }
    ```

*   Dubbo实现

    ```java
    @Service(version = "1.0.0")
    public class ApiAdServiceImpl implements ApiAdService {
        @Autowired
        private AdService adService;
        @Override
        public PageInfo<Ad> queryAdList(Integer type, Integer page, Integer pageSize) {
            Ad ad = new Ad();
            ad.setType(type);
            return this.adService.queryAdList(ad, page, pageSize);
        }
    }
    ```

*   MyBatisConfig & 分页插件

*   启动类

    ```java
    @SpringBootApplication
    public class AdDubboProvider {
        public static void main(String[] args) {
            new SpringApplicationBuilder(AdDubboProvider.class)
                    .web(WebApplicationType.NONE) // 非 Web 应用
                    .run(args);
        }
    }

    ```

*   配置文件

    ```properties
    ## Spring boot application
    spring.application.name = itcast-haoke-manage-dubbo-server-ad
    ## mysql
    spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
    spring.datasource.url=jdbc:mysql://42.193.100.99:3306/haoke?useUnicode=true&characterEncoding=utf8&autoReconnect=true&allowMultiQueries=true&useSSL=false
    spring.datasource.username=root
    spring.datasource.password=root

    spring.dubbo.server=true
    dubbo.scan.basePackages=cn.itcast.haoke.dubbo.server.api

    dubbo.application.name=dubbo-provider-ad
    ## protocol & port
    dubbo.protocol.name=dubbo
    dubbo.protocol.port=21880
    ## zookeeper
    dubbo.registry.address=zookeeper://42.193.100.99:2181;zookeeper://42.193.100.99:2182;zookeeper://42.193.100.99:2183
    dubbo.registry.client=zkclient
    ```

*   RESTful实现

    *   前端接收的格式

        ```json
        {
            "meta": {
                "msg": "成功",
                "status": 200
            },
            "data": {
                "list": [
                    {
                        "url": "https://haoke-1253920081.cos.ap-beijing.myqcloud.com/images/2022/09/29/16644567855393314.jpg"
                    },
                    {
                        "url": "https://haoke-1253920081.cos.ap-beijing.myqcloud.com/images/2022/09/29/16644575095789389.png"
                    },
                    {
                        "url": "https://haoke-1253920081.cos.ap-beijing.myqcloud.com/images/2022/09/29/16644575168817311.jpg"
                    }
                ]
            }
        }
        ```

    *   pojo设计

        ```java
        package cn.itcast.haoke.dubbo.api.vo;

        import com.fasterxml.jackson.annotation.JsonIgnore;
        import lombok.AllArgsConstructor;
        import lombok.Data;

        import java.util.HashMap;
        import java.util.List;
        import java.util.Map;

        @AllArgsConstructor
        @Data
        public class WebResult {
            //在json序列化时将java bean中的一些属性忽略掉
            //一般标记在属性或者方法上，返回的json数据即不包含该属性
            @JsonIgnore
            private int status;
            @JsonIgnore
            private String msg;
            @JsonIgnore
            private List<?> list;
            //静态方法创建对象
            @JsonIgnore
            public static WebResult ok(List<?> list) {
                return new WebResult(200,
                        "成功"
                        , list);
            }
            //静态方法创建对象
            @JsonIgnore
            public static WebResult ok(List<?> list, String msg) {
                return new WebResult(200, msg, list);
            }
            //获取数据集合
            public Map<String, Object> getData() {
                HashMap<String, Object> data = new HashMap<String, Object>();
                data.put("list"
                        , this.list);
                return data;
            }
            //获取元信息（状态、消息）
            public Map<String, Object> getMeta() {
                HashMap<String, Object> meta = new HashMap<String, Object>();
                meta.put("msg"
                        , this.msg);
                meta.put("status"
                        , this.status);
                return meta;
            }
        }
        ```

    *   service

        ```java
        @Service
        public class AdService {

            @Reference(version = "1.0.0")
            private ApiAdService apiAdService;

            public PageInfo<Ad> queryAdList(Integer type, Integer page, Integer pageSize) {
                PageInfo<Ad> pageInfo = this.apiAdService.queryAdList(type, page, pageSize);
                return pageInfo;
            }
        }
        ```

    *   controller

        ```java
        @RestController
        @RequestMapping("ad")
        @CrossOrigin	//解决跨域问题（主机或端口不同会产生跨域问题）
        public class AdController {

            @Autowired
            private AdService adService;

            @GetMapping
            public WebResult queryIndexAd() {
                PageInfo<Ad> pageInfo = this.adService.queryAdList(1, 1, 3);

                ArrayList<Map<String,Object>> data = new ArrayList<>();

                for (Ad ad : pageInfo.getRecords()) {
                    HashMap<String, Object> map = new HashMap<>();
                    map.put("url",ad.getUrl());
                    data.add(map);
                }
                return WebResult.ok(data);
            }
        }
        ```

    *   测试

            http://127.0.0.1:18080/ad

### Mock测试

*   构造数据mock-data.properties

    ```properties
    mock.indexMenu={"data":{"list":[{"id":1,"menu_name":"\u4E8C\u624B\u623F","menu_logo":"home","menu_path":"/home","menu_status":1,"menu_style":null},{"id":2,"menu_name":"\u65B0\u623F","menu_logo":null,"menu_path":null,"menu_status":null,"menu_style":null},{"id":3,"menu_name":"\u79DF\u623F","menu_logo":null,"menu_path":null,"menu_status":null,"menu_style":null},{"id":4,"menu_name":"\u6D77\u5916","menu_logo":null,"menu_path":null,"menu_status":null,"menu_style":null},{"id":5,"menu_name":"\u5730\u56FE\u627E\u623F","menu_logo":null,"menu_path":null,"menu_status":null,"menu_style":null},{"id":6,"menu_name":"\u67E5\u516C\u4EA4","menu_logo":null,"menu_path":null,"menu_status":null,"menu_style":null},{"id":7,"menu_name":"\u8BA1\u7B97\u5668","menu_logo":null,"menu_path":null,"menu_status":null,"menu_style":null},{"id":8,"menu_name":"\u95EE\u7B54","menu_logo":null,"menu_path":null,"menu_status":null,"menu_style":null}]},"meta":{"status":200,"msg":"\u6D4B\u8BD5\u6570\u636E"}}
    mock.indexInfo={"data":{"list":[{"id":1,"info_title":"\u623F\u4F01\u534A\u5E74\u9500\u552E\u4E1A\u7EE9\u7EE7","info_thumb":null,"info_time":null,"info_content":null,"user_id":null,"info_status":null,"info_type":1},{"id":2,"info_title":"\u4E0A\u534A\u5E74\u571F\u5730\u5E02\u573A\u4E24\u91CD\u5929\uFF1A\u4E00\u7EBF\u964D\u6E29\u4E09\u56DB\u7EBF\u91CF\u4EF7\u9F50\u5347","info_thumb":null,"info_time":null,"info_content":null,"user_id":null,"info_status":null,"info_type":1}]},"meta":{"status":200,"msg":"\u6D4B\u8BD5\u6570\u636E"}}
    mock.indexFaq={"data":{"list":[{"question_name":"\u5728\u5317\u4EAC\u4E70\u623F\uFF0C\u9700\u8981\u652F\u4ED8\u7684\u7A0E\u8D39\u6709\u54EA\u4E9B\uFF1F","question_tag":"\u5B66\u533A,\u6D77\u6DC0","answer_content":"\u5404\u79CD\u8D39\u7528","atime":33,"question_id":1,"qnum":2},{"question_name":"\u4E00\u822C\u9996\u4ED8\u4E4B\u540E\uFF0C\u8D37\u6B3E\u591A\u4E45\u53EF\u4EE5\u4E0B\u6765\uFF1F","question_tag":"\u5B66\u533A,\u660C\u5E73","answer_content":"\u5927\u69821\u4E2A\u6708","atime":22,"question_id":2,"qnum":2}]},"meta":{"status":200,"msg":"\u6D4B\u8BD5\u6570\u636E"}}
    mock.indexHouse={"data":{"list":[{"id":1,"home_name":"\u5B89\u8D1E\u897F\u91CC123","home_price":"4511","home_desc":"72.32\u33A1/\u5357 \u5317/\u4F4E\u697C\u5C42","home_infos":null,"home_type":1,"home_tags":"\u6D77\u6DC0,\u660C\u5E73","home_address":null,"user_id":null,"home_status":null,"home_time":12,"group_id":1},{"id":8,"home_name":"\u5B89\u8D1E\u897F\u91CC \u4E09\u5BA4\u4E00\u5385","home_price":"4500","home_desc":"72.32\u33A1/\u5357 \u5317/\u4F4E\u697C\u5C42","home_infos":null,"home_type":1,"home_tags":"\u6D77\u6DC0","home_address":null,"user_id":null,"home_status":null,"home_time":23,"group_id":2},{"id":3,"home_name":"\u5B89\u8D1E\u897F\u91CC \u4E09\u5BA4\u4E00\u5385","home_price":"4220","home_desc":"72.32\u33A1/\u5357 \u5317/\u4F4E\u697C\u5C42","home_infos":null,"home_type":2,"home_tags":"\u6D77\u6DC0","home_address":null,"user_id":null,"home_status":null,"home_time":1,"group_id":1},{"id":4,"home_name":"\u5B89\u8D1E\u897F\u91CC \u4E09\u5BA4\u4E00\u5385","home_price":"4500","home_desc":"72.32\u33A1/\u5357 \u5317/\u4F4E\u697C\u5C42","home_infos":"4500","home_type":2,"home_tags":"\u6D77\u6DC0","home_address":"","user_id":null,"home_status":null,"home_time":12,"group_id":2},{"id":5,"home_name":"\u5B89\u8D1E\u897F\u91CC \u4E09\u5BA4\u4E00\u5385","home_price":"4522","home_desc":"72.32\u33A1/\u5357 \u5317/\u4F4E\u697C\u5C42","home_infos":null,"home_type":3,"home_tags":"\u6D77\u6DC0","home_address":null,"user_id":null,"home_status":null,"home_time":23,"group_id":1},{"id":6,"home_name":"\u5B89\u8D1E\u897F\u91CC \u4E09\u5BA4\u4E00\u5385","home_price":"4500","home_desc":"72.32\u33A1/\u5357 \u5317/\u4F4E\u697C\u5C42","home_infos":null,"home_type":3,"home_tags":"\u6D77\u6DC0","home_address":null,"user_id":null,"home_status":null,"home_time":1221,"group_id":2},{"id":9,"home_name":"\u5B89\u8D1E\u897F\u91CC \u4E09\u5BA4\u4E00\u5385","home_price":"4500","home_desc":"72.32\u33A1/\u5357 \u5317/\u4F4E\u697C\u5C42","home_infos":null,"home_type":4,"home_tags":"\u6D77\u6DC0","home_address":null,"user_id":null,"home_status":null,"home_time":23,"group_id":1}]},"meta":{"status":200,"msg":"\u6D4B\u8BD5\u6570\u636E"}}
    mock.infosList1={"data":{"list":{"total":8,"data":[{"id":13,"info_title":"wwwwwwwwwwwww","info_thumb":null,"info_time":null,"info_content":null,"user_id":null,"info_status":null,"info_type":1},{"id":12,"info_title":"\u623F\u4F01\u534A\u5E74\u9500\u552E\u4E1A\u7EE9\u7EE7","info_thumb":null,"info_time":null,"info_content":null,"user_id":null,"info_status":null,"info_type":1}]}},"meta":{"status":200,"msg":"\u83B7\u53D6\u6570\u636E\u6210\u529F"}}
    mock.infosList2={"data":{"list":{"total":4,"data":[{"id":9,"info_title":"\u623F\u4F01\u534A\u5E74\u9500\u552E\u4E1A\u7EE9\u7EE7\u7EED\u51B2\u9AD8\u4E09\u5DE8\u5934\u9500\u552E\u989D\u8FC7\u4EBF","info_thumb":null,"info_time":null,"info_content":null,"user_id":null,"info_status":null,"info_type":2},{"id":7,"info_title":"\u623F\u4F01\u534A\u5E74\u9500\u552E\u4E1A\u7EE9\u7EE7\u7EED\u51B2\u9AD8\u4E09\u5DE8\u5934\u9500\u552E\u989D\u8FC7\u4EBF","info_thumb":null,"info_time":null,"info_content":null,"user_id":null,"info_status":null,"info_type":2}]}},"meta":{"status":200,"msg":"\u83B7\u53D6\u6570\u636E\u6210\u529F"}}
    mock.infosList3={"data":{"list":{"total":10,"data":[{"username":"tom","question_name":"\u5728\u5317\u4EAC\u4E70\u623F\uFF0C\u9700\u8981\u652F\u4ED8\u7684\u7A0E\u8D39\u6709\u54EA\u4E9B\uFF1F","question_tag":"\u5B66\u533A,\u6D77\u6DC0","answer_content":"\u5404\u79CD\u8D39\u7528","atime":33,"question_id":1,"qnum":2},{"username":"tom","question_name":"\u4E00\u822C\u9996\u4ED8\u4E4B\u540E\uFF0C\u8D37\u6B3E\u591A\u4E45\u53EF\u4EE5\u4E0B\u6765\uFF1F","question_tag":"\u5B66\u533A,\u660C\u5E73","answer_content":"\u5927\u69821\u4E2A\u6708","atime":22,"question_id":2,"qnum":2}]}},"meta":{"status":200,"msg":"\u83B7\u53D6\u6570\u636E\u6210\u529F"}}
    mock.my={"data":{"id":1,"username":"tom","password":"123","mobile":"123","type":null,"status":null,"avatar":"public/icon.png"},"meta":{"status":200,"msg":"\u83B7\u53D6\u6570\u636E\u6210\u529F"}}
    ```

*   创建MockConfig

    ```java
    package cn.itcast.haoke.dubbo.api.config;

    @Configuration
    @PropertySource("classpath:mock-data.properties")
    @ConfigurationProperties(prefix =
    "mock")
    @Data
    public class MockConfig {
        private String indexMenu;
        private String indexInfo;
        private String indexFaq;
        private String indexHouse;
        private String infosList1;
        private String infosList2;
        private String infosList3;
        private String my;
    }
    ```

*   创建MockController

    ```java
    package cn.itcast.haoke.dubbo.api.controller;

    package cn.itcast.haoke.dubbo.api.controller;

    import cn.itcast.haoke.dubbo.api.config.MockConfig;
    import org.springframework.beans.factory.annotation.Autowired;
    import org.springframework.web.bind.annotation.*;

    @RequestMapping("mock")
    @RestController
    @CrossOrigin
    public class MockController {
        @Autowired
        private MockConfig mockConfig;

        /**
         * 菜单
         * @return
         */
        @GetMapping("index/menu")
        public String indexMenu() {
            return this.mockConfig.getIndexMenu();
        }

        /**
         * 首页资讯
         * @return
         */
        @GetMapping("index/info")
        public String indexInfo() {
            return this.mockConfig.getIndexInfo();
        }

        /**
         * 首页问答
         * @return
         */
        @GetMapping("index/faq")
        public String indexFaq() {
            return this.mockConfig.getIndexFaq();
        }

        /**
         * 首页房源信息
         * @return
         */
        @GetMapping("index/house")
        public String indexHouse() {
            return this.mockConfig.getIndexHouse();
        }

        /**
         * 查询资讯
         * @param type
         * @return
         */
        @GetMapping("infos/list")
        public String infosList(@RequestParam("type") Integer type) {
            switch (type) {
                case 1:
                    return this.mockConfig.getInfosList1();
                case 2:
                    return this.mockConfig.getInfosList2();
                case 3:
                    return this.mockConfig.getInfosList3();
            }
            return this.mockConfig.getInfosList1();
        }

        /**
         * 我的中心
         * @return
         */
        @GetMapping("my/info")
        public String myInfo() {
            return this.mockConfig.getMy();
        }
    }
    ```

*   测试

    ```http
    http://127.0.0.1:18080/mock/index/menu
    http://127.0.0.1:18080/mock/infos/list?type=1
    ```

### 缓存

*   在控制层统一添加缓存逻辑

#### 依赖

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>
<dependency>
    <groupId>redis.clients</groupId>
    <artifactId>jedis</artifactId>
    <version>2.9.0</version>
</dependency>
<dependency>
    <groupId>commons-io</groupId>
    <artifactId>commons-io</artifactId>
    <version>2.6</version>
</dependency>
```

#### 配置文件

```properties
spring.redis.host=42.193.100.99
spring.redis.port=6379
spring.redis.jedis.pool.max-wait = 5000
spring.redis.jedis.pool.max-Idle = 100
spring.redis.jedis.pool.min-Idle = 10
spring.redis.timeout = 10
```

#### 配置类

```java
@Configuration
public class RedisConfig {

    @Bean
    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory factory) {
        RedisTemplate<String, Object> template = new RedisTemplate<>();
        template.setConnectionFactory(factory);
        template.setKeySerializer(new StringRedisSerializer());
        template.setValueSerializer(new StringRedisSerializer());
        template.afterPropertiesSet();
        return template;
    }
}
```

#### 编写拦截器

```java
package cn.itcast.haoke.dubbo.api.interceptor;

@Component
public class RedisCacheInterceptor implements HandlerInterceptor {

    @Autowired
    private RedisTemplate<String, String> redisTemplate;

    private static ObjectMapper mapper = new ObjectMapper();

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        //只拦截get请求
        if (!StringUtils.equalsIgnoreCase(request.getMethod(), "get")) {
            return true;
        }
        //分析请求内容，生成要查的redisKey
        String redisKey = createRedisKey(request);
        //查redis
        String data = redisTemplate.opsForValue().get(redisKey);

        if (StringUtils.isEmpty(data)) {
            //缓存未命中，放行
            return true;
        }
        response.setCharacterEncoding("UTF-8");
        response.setContentType("application/json;charset=utf-8");
        
        // 支持跨域
        response.setHeader("Access-Control-Allow-Origin", "*");
        response.setHeader("Access-Control-Allow-Methods", "GET,POST,PUT,DELETE,OPTIONS");
        response.setHeader("Access-Control-Allow-Credentials", "true");
        response.setHeader("Access-Control-Allow-Headers", "Content-Type,X-Token");
        response.setHeader("Access-Control-Allow-Credentials", "true");
        
        response.getWriter().write(data);	//命中了，把数据相应出去
        return false;
    }

    public static String createRedisKey(HttpServletRequest request) throws IOException {
        //获取uri
        String paramString = request.getRequestURI();
        //获取表单参数
        Map<String, String[]> parameterMap = request.getParameterMap();

        if (parameterMap.isEmpty()) {
            /**此处有些问题，如果有graphql发送的post请求，getInputStream只能读取一次数据，
             * 缓存未命中时，放行后再次读取请求体没有数据了
             */
            //表单无数据，那可能在json中（graphql），拼接到uri
            paramString += IOUtils.toString(request.getInputStream(),"UTF-8");
        } else {
            //表单有数据，序列化得到的字符串，拼接到uri
            paramString += mapper.writeValueAsString(parameterMap);
        }

        //对地址进行md5加密、标识（"WEB_DATA"）并返回
        return "WEB_DATA" + DigestUtils.md5Hex(paramString);
    }
}
```

#### 注册拦截器

*   注册到Spring容器

```java
@Configuration
public class WebConfig implements WebMvcConfigurer {
    @Autowired
    private RedisCacheInterceptor redisCacheInterceptor;
    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(this.redisCacheInterceptor).addPathPatterns("/**");
    }
}
```

#### 包装request

*   解决*getInputStream只能读取一次数据，缓存未命中时，放行后，再次读取请求体没有数据*

```java
/**
 * 包装HttpServletRequest
 */
public class MyServletRequestWrapper extends HttpServletRequestWrapper {

    private final byte[] body;

    /**
     * Construct a wrapper for the specified request.
     *
     * @param request The request to be wrapped
     */
    public MyServletRequestWrapper(HttpServletRequest request) throws IOException {
        super(request);
        body = IOUtils.toByteArray(super.getInputStream());
    }

    @Override
    public BufferedReader getReader() throws IOException {
        return new BufferedReader(new InputStreamReader(getInputStream()));
    }

    @Override
    public ServletInputStream getInputStream() throws IOException {
        return new RequestBodyCachingInputStream(body);
    }

    private class RequestBodyCachingInputStream extends ServletInputStream {
        private byte[] body;
        private int lastIndexRetrieved = -1;
        private ReadListener listener;

        public RequestBodyCachingInputStream(byte[] body) {
            this.body = body;
        }

        @Override
        public int read() throws IOException {
            if (isFinished()) {
                return -1;
            }
            int i = body[lastIndexRetrieved + 1];
            lastIndexRetrieved++;
            if (isFinished() && listener != null) {
                try {
                    listener.onAllDataRead();
                } catch (IOException e) {
                    listener.onError(e);
                    throw e;
                }
            }
            return i;
        }

        @Override
        public boolean isFinished() {
            return lastIndexRetrieved == body.length - 1;
        }

        @Override
        public boolean isReady() {
            // This implementation will never block
            // We also never need to call the readListener from this method, as this method will never return false
            return isFinished();
        }

        @Override
        public void setReadListener(ReadListener listener) {
            if (listener == null) {
                throw new IllegalArgumentException("listener cann not be null");
            }
            if (this.listener != null) {
                throw new IllegalArgumentException("listener has been set");
            }
            this.listener = listener;
            if (!isFinished()) {
                try {
                    listener.onAllDataRead();
                } catch (IOException e) {
                    listener.onError(e);
                }
            } else {
                try {
                    listener.onAllDataRead();
                } catch (IOException e) {
                    listener.onError(e);
                }
            }
        }

        @Override
        public int available() throws IOException {
            return body.length - lastIndexRetrieved - 1;
        }

        @Override
        public void close() throws IOException {
            lastIndexRetrieved = body.length - 1;
            body = null;
        }
    }
}
```

*   过滤器
    *   通过过滤器进行包装request对象
    *   继承了OncePerRequestFilter，只处理一次request

```java
/**
 * 替换Request对象
 */
@Component
public class RequestReplaceFilter extends OncePerRequestFilter {

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {
        if (!(request instanceof MyServletRequestWrapper)) {
            request = new MyServletRequestWrapper(request);
        }
        filterChain.doFilter(request, response);
    }
}
```

#### 响应结果写入缓存

*   通过拦截器拿不到响应数据，无法实现
*   通过ResponseBodyAdvice进行实现，在响应之前进行拦截

```java
@ControllerAdvice
public class MyResponseBodyAdvice implements ResponseBodyAdvice {

    @Autowired
    private RedisTemplate<String, String> redisTemplate;

    private ObjectMapper mapper = new ObjectMapper();

    @Override
    public boolean supports(MethodParameter returnType, Class converterType) {
        if (returnType.hasMethodAnnotation(GetMapping.class)) {
            return true;
        }
        return false;
    }

    @Override
    public Object beforeBodyWrite(Object body, MethodParameter returnType, MediaType selectedContentType, Class selectedConverterType, ServerHttpRequest request, ServerHttpResponse response) {
        try {
            String redisKey = RedisCacheInterceptor.createRedisKey(((ServletServerHttpRequest) request).getServletRequest());
            String redisValue;
            if (body instanceof String) {
                redisValue = (String) body;
            } else {
                redisValue = mapper.writeValueAsString(body);
            }
            this.redisTemplate.opsForValue().set(redisKey, redisValue, Duration.ofHours(1));
        } catch (Exception e) {
            e.printStackTrace();
        }
        return body;
    }
}
```

### 实时聊天

*   创建工程itcast-haoke-im

#### 依赖

```xml
<parent>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-parent</artifactId>
    <version>2.1.0.RELEASE</version>
</parent>

<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-mongodb</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-websocket</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-test</artifactId>
        <scope>test</scope>
    </dependency>
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
        <version>1.18.4</version>
    </dependency>
    <dependency>
        <groupId>org.apache.commons</groupId>
        <artifactId>commons-lang3</artifactId>
    </dependency>
</dependencies>
```

#### pojo

```java
//编写Message对象
@Data
@AllArgsConstructor
@NoArgsConstructor
@Document(collection ="message")
@Builder
public class Message {
    @Id
    private ObjectId id;
    private String msg;
    /**
     * 消息状态，1-未读，2-已读
     */
    @Indexed
    private Integer status;
    @Field("send_date")
    @Indexed
    private Date sendDate;
    @Field("read_date")
    private Date readDate;
    @Indexed
    private User from;
    @Indexed
    private User to;
    
}
```

```java
@Data
@AllArgsConstructor
@NoArgsConstructor
@Builder
public class User {
    private Long id;
    private String username;
}
```

```java
//模拟用户
public class UserData {
    public static final Map<Long, User> USER_MAP = new HashMap<>();

    static {
        USER_MAP.put(1001L, User.builder().id(1001L).username("zhangsan").build());
        USER_MAP.put(1002L, User.builder().id(1002L).username("lisi").build());
        USER_MAP.put(1003L, User.builder().id(1003L).username("wangwu").build());
        USER_MAP.put(1004L, User.builder().id(1004L).username("zhaoliu").build());
        USER_MAP.put(1005L, User.builder().id(1005L).username("sunqi").build());
    }
}
```

#### dao

##### 接口

```java
public interface MessageDAO {
    //查询点对点聊天记录
    List<Message> findListByFromAndTo(Long fromId, Long toId, Integer page, Integer rows);

    //根据id查询数据
    Message findMessageById(String id);

    //更新消息状态
    UpdateResult updateMessageState(ObjectId id, Integer status);

    //新增消息数据
    Message saveMessage(Message message);

    //根据消息id删除数据
    DeleteResult deleteMessage(String id);
}
```

##### 实现类

```java
package cn.itcast.haoke.im.dao.impl;

@Component
public class MessageDAOImpl implements MessageDAO {
    @Autowired
    private MongoTemplate mongoTemplate;

    @Override
    public List<Message> findListByFromAndTo(Long fromId, Long toId, Integer page,
                                             Integer rows) {
        Criteria fromList =
                Criteria.where("from.id").is(fromId).and("to.id").is(toId);
        Criteria toList =
                Criteria.where("from.id").is(toId).and("to.id").is(fromId);
        Criteria criteria = new Criteria().orOperator(fromList, toList);
        PageRequest pageRequest = PageRequest.of(page - 1, rows,
                Sort.by(Sort.Direction.ASC,
                        "send_date"));
        Query query = new Query(criteria).with(pageRequest);
        System.out.println(query);
        return this.mongoTemplate.find(query, Message.class);
    }

    @Override
    public Message findMessageById(String id) {
        return this.mongoTemplate.findById(new ObjectId(id), Message.class);
    }

    @Override
    public UpdateResult updateMessageState(ObjectId id, Integer status) {
        Query query = Query.query(Criteria.where("id").is(id));
        Update update = Update.update("status"
                , status);
        if (status.intValue() == 1) {
            update.set("send_date"
                    , new Date());
        } else if (status.intValue() == 2) {
            update.set("read_date"
                    , new Date());
        }
        return this.mongoTemplate.updateFirst(query, update, Message.class);
    }

    @Override
    public Message saveMessage(Message message) {
        message.setId(ObjectId.get());
        message.setSendDate(new Date());
        message.setStatus(1);
        return this.mongoTemplate.save(message);
    }

    @Override
    public DeleteResult deleteMessage(String id) {
        Query query = Query.query(Criteria.where("id").is(id));
        return this.mongoTemplate.remove(query, Message.class);
    }
}
```

##### 测试

```java
@RunWith(SpringRunner.class)
@SpringBootTest(classes = IMApplication.class)
public class TestMessageDAO {
    @Autowired
    private MessageDAO messageDAO;

    @Test
    public void testSave() {
        Message message = Message.builder()
                .id(ObjectId.get())
                .msg("你好")
                .sendDate(new Date())
                .status(1)
                .from(new User(1001L,"zhangsan"))
                .to(new User(1002L,"lisi"))
                .build();
        this.messageDAO.saveMessage(message);
        message = Message.builder()
                .id(ObjectId.get())
                .msg("你也好")
                .sendDate(new Date())
                .status(1)
                .to(new User(1001L,"zhangsan"))
                .from(new User(1002L,"lisi"))
                .build();
        this.messageDAO.saveMessage(message);
        message = Message.builder()
                .id(ObjectId.get())
                .msg("我在学习开发IM")
                .sendDate(new Date())
                .status(1)
                .from(new User(1001L,"zhangsan"))
                .to(new User(1002L,"lisi"))
                .build();
        this.messageDAO.saveMessage(message);
        message = Message.builder()
                .id(ObjectId.get())
                .msg("那很好啊！")
                .sendDate(new Date())
                .status(1)
                .to(new User(1001L,"zhangsan"))
                .from(new User(1002L,"lisi"))
                .build();
        this.messageDAO.saveMessage(message);
        System.out.println("ok");
    }

    @Test
    public void testQueryById() {
        Message message =
                this.messageDAO.findMessageById("5c0a9109235e193bd4873b92");
        System.out.println(message);
    }

    @Test
    public void testQueryList() {
        List<Message> list = this.messageDAO.findListByFromAndTo(1001L, 1002L, 2,
                1);
        for (Message message : list) {
            System.out.println(message);
        }
    }
}
```

#### websocket

*   发消息流程

    > 发消息 --- im服务器 --- mongoDB未读 --- 用户在线 --- 发送给用户 --- 标记已读

*   接收消息流程

    > 拉取消息 --- im服务器 --- MongoDb --- 有未读 --- 修改状态并返回
    >
    > ​												--- 没有未读 --- 直接返回

##### 拦截器

```java
@Component
public class MessageHandshakeInterceptor implements HandshakeInterceptor {
    @Override
    public boolean beforeHandshake(ServerHttpRequest serverHttpRequest, ServerHttpResponse serverHttpResponse, WebSocketHandler webSocketHandler, Map<String, Object> map) throws Exception {
        String path = serverHttpRequest.getURI().getPath();
        String[] split = StringUtils.split(path, "/");
        if (split.length != 2){
            return false;
        }
        //第二个切片不是纯数字不连接
        if (! StringUtils.isNumeric(split[1])){
            return false;
        }
        map.put("uid",Long.valueOf(split[1]));
        return true;
    }

    @Override
    public void afterHandshake(ServerHttpRequest serverHttpRequest, ServerHttpResponse serverHttpResponse, WebSocketHandler webSocketHandler, Exception e) {

    }
}
```

##### 消息处理及注册

```java
package cn.itcast.haoke.im.websocket;

public class MessageHandler extends TextWebSocketHandler implements WebSocketConfigurer {

    @Autowired
    private MessageDAO messageDAO;
    @Autowired
    private MessageHandshakeInterceptor messageHandshakeInterceptor;
    @Autowired
    private MessageHandler messageHandler;

    //用于序列化
    private static final ObjectMapper MAPPER = new ObjectMapper();
    //用于存放消息 <key：发送方id , value：session>
    private static final Map<Long, WebSocketSession> SESSIONS = new HashMap<>();


    @Override
    public void afterConnectionEstablished(WebSocketSession session) throws Exception {
        Long uid = (Long) session.getAttributes().get("uid");
        // 将当前用户的session放置到map中，后面会使用相应的session通信
        SESSIONS.put(uid, session);
    }

    @Override
    protected void handleTextMessage(WebSocketSession session, TextMessage message) throws Exception {
        //获取fromId
        Long uid = (Long) session.getAttributes().get("uid");
        //获取toId、msg
        JsonNode jsonNode = MAPPER.readTree(message.getPayload());
        long toId = jsonNode.get("toId").asLong();
        String msg = jsonNode.get("msg").asText();
        //创建message对象
        Message textMessage = Message.builder()
                .from(UserData.USER_MAP.get(uid))
                .to(UserData.USER_MAP.get(toId))
                .msg(msg)
                .build();
        // 将消息保存到MongoDB
        textMessage = messageDAO.saveMessage(textMessage);
        // 判断to用户是否在线
        WebSocketSession toSession = SESSIONS.get(toId);
        if (toSession != null && toSession.isOpen()){
            // TODO 具体格式与前端对接
            toSession.sendMessage(new TextMessage(MAPPER.writeValueAsString(textMessage)));
            //更新消息状态
            messageDAO.updateMessageState(textMessage.getId(),2);
        }
    }

    @Override
    public void registerWebSocketHandlers(WebSocketHandlerRegistry webSocketHandlerRegistry) {
        webSocketHandlerRegistry.addHandler(messageHandler,"/ws/{uid}")
                .setAllowedOrigins("*")
                .addInterceptors(messageHandshakeInterceptor);
    }
}
```

##### 配置类

*   注册也可以放到配置类

```java
@Configuration
@EnableWebSocket
public class WebSocketConfig {
}
```

##### 启动类

```java
@SpringBootApplication
public class IMApplication {
    public static void main(String[] args) {
        SpringApplication.run(IMApplication.class,args);
    }
}
```

##### 测试

```json
ws://127.0.0.1:18081/ws/1001

{
    "toId" : 1002,
    "msg" : "你好，1002，在吗"
}
```

```json
ws://127.0.0.1:18081/ws/1002

{
    "toId" : 1001,
    "msg" : "在的"
}
```

*   报read timeout，配置超时时间

    ```properties
    server.connection-timeout=1000000
    ```

#### 消息记录

##### controller

```java
@RestController
@RequestMapping("message")
@CrossOrigin
public class MessageController {
    @Autowired
    private MessageService messageService;

    @GetMapping
    public List<Message> queryMessageList(
            @RequestParam("fromId") Long fromId,
            @RequestParam("toId") Long toId,
            @RequestParam(value = "page",defaultValue = "1")Integer page,
            @RequestParam(value = "rows",defaultValue = "10")Integer rows
    ){
        return messageService.queryMessageList(fromId, toId, page, rows);
    }
}
```

##### service

```java
@Service
public class MessageService {

    @Autowired
    private MessageDAO messageDAO;

    public List<Message> queryMessageList(Long fromId, Long toId, Integer page, Integer rows) {
        List<Message> messageList = messageDAO.findListByFromAndTo(fromId, toId, page, rows);
        for (Message message : messageList) {
            if (message.getStatus().intValue() == 1)
                messageDAO.updateMessageState(message.getId(), 2);
        }
        return messageList;
    }
}
```

##### 测试

```http
http://127.0.0.1:18081/message?fromId=1001&toId=1002
```

#### 用户列表

##### 数据结构

```json
{
    "data": {
        "list": [
            {
                "id": 3,
                "from_user": 1,
                "to_user": 3,
                "chat_time": 1531045313395,
                "chat_msg": "12213123",
                "info_type": null,
                "username": "spike",
                "avatar": "public/icon.png"
            },
            {
                "id": 4,
                "from_user": 1,
                "to_user": 3,
                "chat_time": 1531045313395,
                "chat_msg": "12",
                "info_type": null,
                "username": "spike",
                "avatar": "public/icon.png"
            }
        ]
    },
    "meta": {
        "status": 200,
        "msg": "用户数据"
    }
}
```

##### controller

```java
@RestController
@RequestMapping("user")
@CrossOrigin
public class UserController {

    @Autowired
    private MessageService messageService;

    @GetMapping
    public List<Map<String, Object>> queryUserList(@RequestParam("fromId") Long fromId) {
        ArrayList<Map<String, Object>> result = new ArrayList<>();

        for (Map.Entry<Long,User> userEntry:UserData.USER_MAP.entrySet()) {
            HashMap<String, Object> map = new HashMap<>();
            map.put("id",userEntry.getValue().getId());
            map.put("avatar","头像图片地址");
            map.put("from_user",fromId);
            map.put("to_user",map.get("id"));
            map.put("info_type",null);
            map.put("username",userEntry.getValue().getUsername());

            //获取最后一条消息
            List<Message> messages = messageService.queryMessageList(fromId,
                    userEntry.getValue().getId(), 1, 1);
            if (messages != null && !messages.isEmpty()){
                Message message = messages.get(0);
                map.put("chat_msg",message.getMsg());
                map.put("chat_time",message.getSendDate());
            }
            
            result.add(map);
        }
        return result;
    }

}
```

##### 测试

```http
http://127.0.0.1:18081/user?fromId=1001
```

#### 分布式Socket解决方案

*   问题：前面的实现中，将Session对象放到全局的Map中，当连接变得非常多时，这将成为了系统瓶颈，因为不能进行分布式部署
*   解决：消息中间件

##### 安装rocketmq

```sh
#拉取镜像
docker pull foxiswho/rocketmq:server-4.3.2
docker pull foxiswho/rocketmq:broker-4.3.2

#创建nameserver容器
docker run -p 9876:9876 --name rmqserver -d \
-e "JAVA_OPT_EXT=-server -Xms128m -Xmx128m -Xmn128m" \
-e "JAVA_OPTS=-Duser.home=/opt" \
-v /usr/local/rmq/rmqserver/logs:/opt/logs \
-v /usr/local/rmq/rmqserver/store:/opt/store \
foxiswho/rocketmq:server-4.3.2

#创建broker容器
mkdir -p /haoke/rmq/rmqbroker/conf /haoke/rmq/rmqbroker/logs /haoke/rmq/rmqbroker/store
docker run -p 10911:10911 -p 10909:10909 --name rmqbroker -d \
-e "JAVA_OPTS=-Duser.home=/opt" \
-e "JAVA_OPT_EXT=-server -Xms128m -Xmx128m -Xmn128m" \
-v  /usr/local/rmq/rmqbroker/conf/broker.conf:/etc/rocketmq/broker.conf \
-v  /usr/local/rmq/rmqbroker/logs:/opt/logs \
-v  /usr/local/rmq/rmqbroker/store:/opt/store \
foxiswho/rocketmq:broker-4.3.2

#停止删除容器
docker stop rmqbroker rmqserver
docker rm rmqbroker rmqserver


#拉取镜像
docker pull styletang/rocketmq-console-ng:1.0.0
#创建并启动容器
docker run -d -p 9999:8080 --name rmqadmin \
--restart=always \
-e "JAVA_OPTS=-Drocketmq.namesrv.addr=192.168.10.111:9876 \
-Dcom.rocketmq.sendMessageWithVIPChannel=false \
-Duser.timezone='Asia/Shanghai'" \
-v /etc/localtime:/etc/localtime \
-t styletang/rocketmq-console-ng:1.0.0
```

##### 依赖

```xml
<!--RocketMQ相关依赖-->
<dependency>
    <groupId>org.apache.rocketmq</groupId>
    <artifactId>rocketmq-spring-boot-starter</artifactId>
    <version>2.0.3</version>
</dependency>
<dependency>
    <groupId>org.apache.rocketmq</groupId>
    <artifactId>rocketmq-client</artifactId>
    <version>4.3.2</version>
</dependency>
```

##### 配置文件

```yml
## Spring boot application
spring:
  application:
    name: itcast-haoke-im
  data:
    mongodb:
      uri: mongodb://42.193.100.99:27017/testdb
#
server:
  port: 18081
  connection-timeout: 10000000

rocketmq:
  name-server: 192.168.10.111:9876
  producer:
    group: haoke-im-websocket-group  ## 指定发送者组名
```

##### 实现离线会话

```java
@Component
@RocketMQMessageListener(topic = "haoke-im-send-message-topic",
        consumerGroup = "haoke-im-consumer",
        messageModel = MessageModel.BROADCASTING,
        selectorExpression = "SEND_MSG")
public class MessageHandler extends TextWebSocketHandler implements WebSocketConfigurer, RocketMQListener<String> {

    @Autowired
    private RocketMQTemplate rocketMQTemplate;
    @Autowired
    private MessageDAO messageDAO;
    @Autowired
    private MessageHandshakeInterceptor messageHandshakeInterceptor;
    @Autowired
    private MessageHandler messageHandler;

    //用于序列化
    private static final ObjectMapper MAPPER = new ObjectMapper();
    //用于存放消息 <key：发送方id , value：session>
    private static final Map<Long, WebSocketSession> SESSIONS = new HashMap<>();


    @Override
    public void afterConnectionEstablished(WebSocketSession session) throws Exception {
        Long uid = (Long) session.getAttributes().get("uid");
        // 将当前用户的session放置到map中，后面会使用相应的session通信
        SESSIONS.put(uid, session);
    }

    @Override
    protected void handleTextMessage(WebSocketSession session, TextMessage message) throws Exception {
        //获取fromId
        Long uid = (Long) session.getAttributes().get("uid");
        //获取toId、msg
        JsonNode jsonNode = MAPPER.readTree(message.getPayload());
        long toId = jsonNode.get("toId").asLong();
        String msg = jsonNode.get("msg").asText();
        //创建message对象
        Message textMessage = Message.builder()
                .from(UserData.USER_MAP.get(uid))
                .to(UserData.USER_MAP.get(toId))
                .msg(msg)
                .build();
        // 将消息保存到MongoDB
        textMessage = messageDAO.saveMessage(textMessage);
        String msgStr = MAPPER.writeValueAsString(textMessage);
        // 判断to用户是否在线
        WebSocketSession toSession = SESSIONS.get(toId);
        if (toSession != null && toSession.isOpen()){
            // TODO 具体格式与前端对接
            toSession.sendMessage(new TextMessage(msgStr));
            //更新消息状态
            messageDAO.updateMessageState(textMessage.getId(),2);
        }else {
            // 用户不在线，或者不在当前的jvm中，发送消息到RocketMQ
            org.springframework.messaging.Message mqMessage = MessageBuilder
                    .withPayload(msgStr)
                    .build();
            // topic:tags 设置主题和标签
            this.rocketMQTemplate.send("haoke-im-send-message-topic:SEND_MSG",mqMessage);
        }
    }

    @Override
    public void registerWebSocketHandlers(WebSocketHandlerRegistry webSocketHandlerRegistry) {
        webSocketHandlerRegistry.addHandler(messageHandler,"/ws/{uid}")
                .setAllowedOrigins("*")
                .addInterceptors(messageHandshakeInterceptor);
    }

    @Override
    public void onMessage(String msg) {

        try {
            JsonNode jsonNode = MAPPER.readTree(msg);
            long toId = jsonNode.get("to").get("id").longValue();
            WebSocketSession toSession = SESSIONS.get(toId);
            if (toSession != null && toSession.isOpen()) {
                toSession.sendMessage(new TextMessage(msg));
                messageDAO.updateMessageState(new ObjectId(jsonNode.get("id").asText()),2);
            }
        } catch (IOException e) {
            e.printStackTrace();
        }

    }
}
```

**Message对象添加ObjectId的注解**

```java
@Id
@JsonSerialize(using = ToStringSerializer.class)
private ObjectId id;
```

##### 测试

## 整合前端

### 新增房源

#### 增加房源标题

之前的前端页面实现中，缺少了标题一项，现补上

```jsx
<FormItem {...formItemLayout} label="房源标题">
{getFieldDecorator('title',{rules:[{ required: true,message:"此项为必填项" }]})(<Input style={{ width: '100%' }} />)}
</FormItem>
```

#### 增加model

![image-20220928000336843](http://minio.botuer.com/study-node/old/image-20220928000336843.png)

*   form.js文件

    ```jsx
    import { routerRedux } from 'dva/router';
    import { message } from 'antd';
    import { addHouseResource } from '@/services/haoke';
    export default {
        namespace: 'house',
        state: {
        },
        effects: {
            *submitHouseForm({ payload }, { call }) {
                yield call(addHouseResource, payload);
                message.success('提交成功');
            }
        },
        reducers: {
            saveStepFormData(state, { payload }) {
                return {
                	...state
                };
            },
        },
    };
    ```

#### 增加services

*   haoke.js，用于请求服务并且处理业务逻辑

    ```jsx
    import request from '@/utils/request';
    export async function addHouseResource(params) {
        return request('/haoke/house/resources', {
        	method: 'POST',
        	body: params
        });
    }
    ```

#### 修改表单提交地址

*   AddResource.js

    ```jsx
    dispatch({
        type: 'house/submitHouseForm',
        payload: values,
    });
    ```

#### 通过反向代理解决跨域问题

*   由于我们前端系统和后台服务系统的端口不同，会导致跨域问题，我们通过umi提供的反向代理功能解决这个问题

*   配置地址：<https://umijs.org/zh/config/#proxy>

*   在config.js中进行配置proxy

    ```jsx
    proxy: {
        '/haoke/': {
            target: 'http://127.0.0.1:18080',
            changeOrigin: true,
            pathRewrite: { '^/haoke/': '' }
        }
    },
    ```

*   配置代理后，以/haoke开头的请求，就会被代理
    代理效果是这样的：
    请求：<http://localhost:8000/haoke/house/resources>
    实际：<http://127.0.0.1:18080/house/resources>

#### 测试

### 上传图片

#### PicturesWall.js

*   改图片地址

```jsx
return (
    <div>
        <Upload
            action="/haoke/pic/upload"	//改图片地址
            listType="picture-card"
            fileList={fileList}
            onPreview={this.handlePreview}
            onChange={this.handleChange}
        >
            {fileList.length >= 5 ? null : uploadButton}
        </Upload>
        <Modal visible={previewVisible} footer={null} onCancel={this.handleCancel}>
            <img alt="example" style={{ width: '100%' }} src={previewImage} />
        </Modal>
    </div>
);
```

#### AddResource.js

*   修改表单提交逻辑中的图片数据的处理:多个图片的url以逗号分隔
*   修改图片上传完成的变更方法

```jsx
//楼盘id
values.estateId = this.state.estateId;
//修改表单提交逻辑中的图片数据的处理:多个图片的url以逗号分隔
values.pic = [this.state.pics].join(',');		

dispatch({
  type: 'house/submitHouseForm',
  payload: values,
});


//...................
//修改图片上传完成的变更方法
handleFileList = (obj) => {
  let pics = new Set();
  obj.forEach((v, k) => {
    if (v.response) {
      pics.add(v.response.name);
    }
  });
  this.setState({
    pics: pics
  })
}
```

#### 测试

*   报错

        Maximum upload size exceeded; nested exception is java.lang.IllegalStateException: org.apache.tomcat.util.http.fileupload.FileUploadBase$FileSizeLimitExceededException: The field file exceeds its maximum permitted size of 1048576 bytes.

    ```properties
    #修改配置文件

    #每个文件大小，默认1MB
    spring.servlet.multipart.max-file-size=10MB
    #每次请求大小，默认10MB
    spring.servlet.multipart.max-request-size=10MB
    ```

### 房源列表

#### 修改请求数据地址

*   在service目录下houseResource.js

```jsx
import request from '@/utils/request';
import { stringify } from 'qs';

export async function queryResource(params) {
  return request(`/haoke/house/resource?${stringify(params)}`);	//改请求地址
}
```

#### 修改字段结构

*   在haoke/House/Resource.js

```jsx
columns = [
  {
    title: '房源编号'
    ,
    dataIndex: 'id'
    ,
  },
  {
    title: '房源信息'
    ,
    dataIndex: 'title'
    ,
  },
  {
    title: '图'
    ,
    dataIndex: 'pic'
    ,
    render: (text, record, index) => {
      return <ShowPics pics={text} />
    }
  },
  {
    title: '楼栋'
    ,
    render: (text, record, index) => {
      return record.buildingFloorNum + "栋" + record.buildingNum + "单元" + record.buildingUnit + "号"
    }
  },
  {
    title: '支付方式'
    ,
    render: (text, record, index) => {
      return payType.get(record.paymentMethod)
    }
  },
  {
    title: '户型'
    ,
    dataIndex: 'houseType'
  },
  {
    title: '面积'
    ,
    dataIndex: 'useArea'
    ,
    render: (text, record, index) => {
      return text + "平方"
    }
  },
  {
    title: '楼层'
    ,
    dataIndex: 'floor'
  },
  {
    title: '操作'
    ,
    render: (text, record) => (
      <Fragment>
        <a onClick={() => this.handleUpdateModalVisible(true, record)}>查看</a>
        <Divider type=
          "vertical" />
        <a href=
          "">删除</a>
      </Fragment>

    ),
  },
];
```

#### 图片显示走马灯效果

在haoke/House/下新建ShowPics

```jsx
import React from 'react';
import { Modal, Button, Carousel } from 'antd';
class ShowPics extends React.Component {
    info = () => {
        Modal.info({
            title: ''
            ,
            iconType: 'false'
            ,
            width: '800px'
            ,
            okText: "ok"
            ,
            content: (
                <div style={{ width: 650, height: 400, lineHeight: 400, textAlign: "center" }}>
                    <Carousel autoplay={true}>
                        {
                            this.props.pics.split(',').map((value, index) => {
                                return <div><img style={{
                                    maxWidth: 600, maxHeight: 400, margin: "0auto"
                                }} src={value} /></div>
                            })
                        }
                    </Carousel>
                </div>
            ),
            onOk() { },
        });
    };
    constructor(props) {
        super(props);
        this.state = {
            btnDisabled: this.props.pics ? false : true
        }
    }
    render() {
        return (
            <div>
                <Button disabled={this.state.btnDisabled} icon=
                    "picture" shape=
                    "circle"
                    onClick={() => { this.info() }} />
            </div>
        )
    }
}
export default ShowPics;
```

